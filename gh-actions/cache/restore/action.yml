inputs:
  artifact-id:
    type: string
    default:
  artifact-name:
    type: string
    default:
  artifact-wf-path:
    type: string
    default:
  key:
    type: string
    required: true
  command:
    type: string
    default:
  gcs-bucket:
    type: string
    default:
  owner:
    type: string
    default: runner:docker
  path:
    type: string
    default:
  path-script:
    type: string
    default: /tmp/cachescript
  path-tmp:
    type: string
    default: /tmp/cache
  run-as-sudo:
    type: boolean
    default: false
  mount-tmpfs:
    type: boolean
    default: false

runs:
  using: "composite"
  steps:
  - run: |
      if [[ "${{ inputs.run-as-sudo }}" == 'true' ]]; then
          sudo mkdir -p ${{ inputs.path || inputs.path-tmp }}
      else
          mkdir -p ${{ inputs.path || inputs.path-tmp }}
      fi
      if [[ "${{ inputs.mount-tmpfs }}" == 'true' ]]; then
          sudo mount -t tmpfs none ${{ inputs.path || inputs.path-tmp }}
      fi
      if [[ "${{ inputs.run-as-sudo }}" == 'true' ]]; then
          sudo chown -R ${{ inputs.owner }} ${{ inputs.path || inputs.path-tmp }}
      fi
    shell: bash

  # Restore cache
  - name: Restore cache
    if: >-
      ! inputs.gcs-bucket
      && ! inputs.artifact-name
    id: cache-restore
    uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
    with:
      path: ${{ inputs.path || inputs.path-tmp }}
      key: ${{ inputs.key }}
  - name: Restore GCS cache
    if: inputs.gcs-bucket
    id: cache-restore-gcs
    uses: envoyproxy/toolshed/gh-actions/gcs/cache/restore@actions-v0.3.30
    with:
      bucket: ${{ inputs.gcs-bucket }}
      path: ${{ inputs.path || inputs.path-tmp }}
      key: ${{ inputs.key }}
  - name: Restore artifact cache
    if: inputs.artifact-name
    id: cache-restore-artifact
    uses: envoyproxy/toolshed/gh-actions/github/artifact/cache/restore@0df07afbbea88bc5248813829ee49439747002d2
    with:
      id: ${{ inputs.artifact-id }}
      name: ${{ inputs.artifact-name }}
      path: ${{ inputs.path || inputs.path-tmp }}
      wf-path: ${{ inputs.artifact-wf-path }}

  # Command
  - run: |
      # Create cache script
      cat <<'EOF' >> "${{ inputs.path-script }}"
      #!/bin/bash -e

      set -o pipefail

      ${{ inputs.command }}
      EOF
      chmod +x "${{ inputs.path-script }}"
    shell: bash
    if: ${{ inputs.command }}
  - run: |
      cd ${{ inputs.path || inputs.path-tmp }} || exit 1
      if [[ "${{ inputs.run-as-sudo }}" == 'true' ]]; then
          sudo "${{ inputs.path-script }}"
      else
          "${{ inputs.path-script }}"
      fi
      cd - || exit 1
    shell: bash
    if: ${{ inputs.command }}

  - run: |
      if [[ "${{ inputs.mount-tmpfs }}" == 'true' ]]; then
          sudo umount ${{ inputs.path-tmp }}
      fi
      sudo rm -rf ${{ inputs.path-tmp }}
    if: ${{ ! inputs.path }}
    shell: bash
