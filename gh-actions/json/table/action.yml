
inputs:
  append:
    type: boolean
    default: true
  collapse:
    type: boolean
    default: true
  collapse-open:
    type: boolean
    default: false
  column-filter:
    type: string
    default:
  columns:
    type: number
    default: 2
  title:
    type: string
  show-empty:
    type: boolean
    default: false
  summary:
    type: string
  headers:
    type: string
    default: |
      - Variable
      - Value
  json:
    type: string
    required: true
  filter:
    default:
  sanitize-filter:
    default: >-
      if type == "null" then
        ""
      else
        .
      end
      | if (type == "boolean" or type == "number") then
          "`\(.)`"
        else
          .
        end
      | if (type == "object") then
          tojson
        else
          .
        end
      | if (type == "string" and test("\n")) then
          (split("\n")[0] + "..." )
        else
          .
        end
  mutate-cells:
    default: .
  output-path:
    type: string

outputs:
  table:
    value: ${{ steps.table.outputs.value }}
  summary:
    value: ${{ steps.summary.outputs.out }}


runs:
  using: composite
  steps:
  - id: row-count
    uses: envoyproxy/toolshed/gh-actions/jq@e93429ea562db85f9b037048c0ca5c86c02367f9
    with:
      input: |
        ${{ inputs.json }}
      options: -r
      filter: >-
        ${{ inputs.filter || '.' }}
        | length
  - id: headers
    uses: envoyproxy/toolshed/gh-actions/jq@e93429ea562db85f9b037048c0ca5c86c02367f9
    if: ${{ fromJSON(steps.row-count.outputs.value) != 0 || fromJSON(inputs.show-empty) }}
    with:
      input: |
        ${{ inputs.headers }}
      input-format: yaml
      filter: >-
        ("| " + (. | join(" | ")) + " |")
        + "\n"
        + ("| " + "--- | " * ${{ inputs.columns }})
  - id: columns
    if: ${{ fromJSON(steps.row-count.outputs.value) != 0 || fromJSON(inputs.show-empty) }}
    run: |
      # Use k for 1-col, k/v for 2-col, and k/v/v for more
      if [[ "${{ inputs.columns }}" -eq 1 ]]; then
          FILTER='to_entries | map([.key])'
      elif [[ "${{ inputs.columns }}" -eq 2 ]]; then
          FILTER='to_entries | map([.key, .value])'
      else
          FILTER='to_entries | map([.key, (.value | to_entries | map(.value))])'
      fi
      printf 'filter=%s' "$FILTER" >> $GITHUB_OUTPUT
    shell: bash
  - id: mutated-cells
    if: ${{ fromJSON(steps.row-count.outputs.value) != 0 || fromJSON(inputs.show-empty) }}
    uses: envoyproxy/toolshed/gh-actions/shout@e93429ea562db85f9b037048c0ca5c86c02367f9
    with:
      string: >-
        . as $table
        | map(. as $row
              | map(. as $cell
                    | ${{ inputs.mutate-cells || '.' }}
                    | ${{ inputs.sanitize-filter || '.' }}))
  - uses: envoyproxy/toolshed/gh-actions/jq@e93429ea562db85f9b037048c0ca5c86c02367f9
    name: Generate table
    id: table
    if: ${{ fromJSON(steps.row-count.outputs.value) != 0 || fromJSON(inputs.show-empty) }}
    with:
      input: ${{ inputs.json }}
      options: -r
      print-result: true
      filter: |
        ${{ inputs.filter || '.' }}
        | ${{ inputs.column-filter || steps.columns.outputs.filter }}
        | ${{ steps.mutated-cells.outputs.out }}
        | map(join("|"))
        | join("\n") as $columns
        | ${{ steps.headers.outputs.value }}
        | . + "\n" + $columns
        | if ${{ inputs.collapse }} then
            str::indent(2)
          else . end

  - if: ${{ (fromJSON(steps.row-count.outputs.value) != 0 || fromJSON(inputs.show-empty)) && fromJSON(inputs.collapse) }}
    uses: envoyproxy/toolshed/gh-actions/shout@e93429ea562db85f9b037048c0ca5c86c02367f9
    with:
      string: |

        <details ${{ fromJSON(inputs.collapse-open) && 'open' || '' }}>
          <summary><b>${{ inputs.title }}</b></summary>

          #### ${{ inputs.summary }}

        ${{ steps.table.outputs.value }}

        </details>
    id: summary

  - if: ${{ (fromJSON(steps.row-count.outputs.value) != 0 || fromJSON(inputs.show-empty)) && inputs.output-path && ! fromJSON(inputs.collapse) }}
    uses: envoyproxy/toolshed/gh-actions/shout@e93429ea562db85f9b037048c0ca5c86c02367f9
    with:
      string: |
        ${{ inputs.title && format('### {0}', inputs.title) }}
        ${{ steps.table.outputs.value }}
      output-path: ${{ inputs.output-path }}
  - if: ${{ (fromJSON(steps.row-count.outputs.value) != 0 || fromJSON(inputs.show-empty)) && inputs.output-path && fromJSON(inputs.collapse) }}
    uses: envoyproxy/toolshed/gh-actions/shout@e93429ea562db85f9b037048c0ca5c86c02367f9
    with:
      string: ${{ steps.summary.outputs.out }}
      output-path: ${{ inputs.output-path }}
