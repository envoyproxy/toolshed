
inputs:
  append:
    type: boolean
    default: true
  column-filter:
    type: string
    default:
  columns:
    type: number
    default: 2
  title:
    type: string
  show-empty:
    type: boolean
    default: false
  summary:
    type: string
  headers:
    type: string
    default: |
      - Variable
      - Value
  json:
    type: string
    required: true
  filter:
    default:
  sanitize-filter:
    default: >-
      if type == "null" then
        ""
      else
        .
      end
      | if (type == "boolean" or type == "number") then
          "`\(.)`"
        else
          .
        end
      | if (type == "object") then
          tojson
        else
          .
        end
      | if (type == "string" and test("\n")) then
          (split("\n")[0] + "..." )
        else
          .
        end
  mutate-cells:
    default: .
  output-path:
    type: string
  collapse:
    type: boolean
    default: false

outputs:
  table:
    value: ${{ steps.table.outputs.value }}
  summary:
    value: ${{ steps.summary.outputs.out }}


runs:
  using: composite
  steps:
  - id: row-count
    uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.52
    with:
      input: |
        ${{ inputs.json }}
      options: -r
      filter: >-
        ${{ inputs.filter || '.' }}
        | length

  - id: headers
    uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.52
    if: ${{ steps.row-count.outputs.value != 0 || inputs.show-empty }}
    with:
      input: |
        ${{ inputs.headers }}
      input-format: yaml
      filter: >-
        ("| " + (. | join(" | ")) + " |")
        + "\n"
        + ("| " + "--- | " * ${{ inputs.columns }})
  - id: columns
    if: ${{ steps.row-count.outputs.value != 0 || inputs.show-empty }}
    run: |
      # Use k for 1-col, k/v for 2-col, and k/v/v for more
      if [[ "${{ inputs.columns }}" -eq 1 ]]; then
          FILTER='to_entries | map([.key])'
      elif [[ "${{ inputs.columns }}" -eq 2 ]]; then
          FILTER='to_entries | map([.key, .value])'
      else
          FILTER='to_entries | map([.key, (.value | to_entries | map(.value))])'
      fi
      printf 'filter=%s' "$FILTER" >> $GITHUB_OUTPUT
    shell: bash

  - id: mutated-cells
    if: ${{ steps.row-count.outputs.value != 0 || inputs.show-empty }}
    uses: envoyproxy/toolshed/gh-actions/shout@actions-v0.1.52
    with:
      string: >-
        . as $table
        | map(. as $row
              | map(. as $cell
                    | ${{ inputs.mutate-cells || '.' }}
                    | ${{ inputs.sanitize-filter || '.' }}))

  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.52
    name: Generate table
    id: table
    if: ${{ steps.row-count.outputs.value != '0' || fromJSON(inputs.show-empty) }}
    with:
      input: ${{ inputs.json }}
      options: -r
      filter: |
        ${{ inputs.filter || '.' }}
        | ${{ inputs.column-filter || steps.columns.outputs.filter }}
        | ${{ steps.mutated-cells.outputs.out }}
        | map(join("|"))
        | join("\n") as $columns
        | ${{ steps.headers.outputs.value }}
        | . + "\n" + $columns

  - name: Summary
    if: ${{ (steps.row-count.outputs.value != '0' || fromJSON(inputs.show-empty)) && ! inputs.collapse }}
    uses: envoyproxy/toolshed/gh-actions/shout@actions-v0.1.52
    with:
      string: |
        ${{ inputs.title && format('### {0}', inputs.title) }}
        ${{ steps.table.outputs.value }}
      output-path: GITHUB_STEP_SUMMARY

  - uses: envoyproxy/toolshed/gh-actions/str/indent@actions-v0.1.52
    id: indented
    if: ${{ inputs.collapse }}
    with:
      string: ${{ steps.table.outputs.value }}
      indent: 2

  - name: Summary
    if: ${{ (steps.row-count.outputs.value != '0' || fromJSON(inputs.show-empty)) && inputs.collapse }}
    uses: envoyproxy/toolshed/gh-actions/shout@actions-v0.1.52
    with:
      string: |

        <details>
          <summary><b>${{ inputs.title }}</b></summary>

          #### ${{ inputs.summary }}

        ${{ steps.indented.outputs.string }}

        </details>
    id: summary

  - run: |
      if [[ "${{ inputs.output-path }}" == "GITHUB_STEP_SUMMARY" ]]; then
          printf '%s\n' "${REQUEST}" >> $GITHUB_STEP_SUMMARY
      else
          printf '%s\n' "${REQUEST}" >> ${{ inputs.output-path }}
      fi
    shell: bash
    if: ${{ (steps.row-count.outputs.value != '0' || fromJSON(inputs.show-empty)) && inputs.output-path }}
    env:
      REQUEST: ${{ steps.summary.outputs.out }}
