name: Test runner
description: Test GitHub Actions with fixtures and side effect validation
author: phlax

inputs:
  config:
    description: Test configuration YAML
    type: string
    required: true
  name:
    description: Name of the test
    type: string
    default: Action Test

outputs:
  result:
    description: Test result (pass/fail)
    value: ${{ steps.final-result.outputs.result }}


runs:
  using: composite
  steps:
  - uses: envoyproxy/toolshed/gh-actions/jq@346c9ef603ec945dd740fe0053a0b022d5fec3c3
    id: config
    with:
      input: ${{ inputs.config }}
      input-format: yaml
      print-result: true
      filter: |
        . as $config
        | .before as $before
        | .after as $after
        | {uses, with: (.with // {})}
        | if $config.id then
            .id = $config.id
          else . end
        | ($before // []) + [.] + ($after // [])

  - uses: envoyproxy/toolshed/gh-actions/using/steps@346c9ef603ec945dd740fe0053a0b022d5fec3c3
    id: run
    with:
      name: Run test
      steps: ${{ steps.config.outputs.value }}
      step-format: json
