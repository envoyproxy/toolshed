uses: ./gh-actions/diskspace
id: diskspace

before:
- shell: bash
  run: |
    sudo mkdir -p /opt/hostedtoolcache
    sudo mkdir -p /usr/local/lib/android
    sudo mkdir -p /usr/local/.ghcup

after:
- shell: bash
  run: |
    if [[ -z "${{ steps.diskspace.outputs.pids }}" ]]; then
        echo "fail:PIDs output is empty" >> "$TEST_OUTPUT"
    else
        echo "success:Background mode returned PIDs: ${{ steps.diskspace.outputs.pids }}" >> "$TEST_OUTPUT"
    fi

    for pid in ${{ steps.diskspace.outputs.pids }}; do
        echo "Waiting for process $pid to complete..."
        timeout=120
        while kill -0 "$pid" 2>/dev/null && [[ "$timeout" -gt 0 ]]; do
            sleep 1
            timeout=$((timeout - 1))
        done
        if [[ "$timeout" -eq 0 ]]; then
            echo "Warning: Process $pid did not complete in time"
        else
            echo "success:Process $pid completed" >> "$TEST_OUTPUT"
        fi
    done

    echo ""
    echo "Verifying directories have been removed..."
    if [[ -d "/opt/hostedtoolcache" ]]; then
        echo "fail:/opt/hostedtoolcache still exists" >> "$TEST_OUTPUT"
    else
        echo "success:/opt/hostedtoolcache has been removed" >> "$TEST_OUTPUT"
    fi

    if [[ -d "/usr/local/lib/android" ]]; then
        echo "fail:/usr/local/lib/android still exists" >> "$TEST_OUTPUT"
    else
        echo "success:/usr/local/lib/android has been removed" >> "$TEST_OUTPUT"
    fi

    if [[ -d "/usr/local/.ghcup" ]]; then
        echo "fail:/usr/local/.ghcup still exists" >> "$TEST_OUTPUT"
    else
        echo "success:/usr/local/.ghcup has been removed" >> "$TEST_OUTPUT"
    fi
