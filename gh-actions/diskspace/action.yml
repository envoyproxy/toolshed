inputs:
  to_remove:
    type: string
    default:
  background:
    type: boolean
    default: true
    description: "Run removal commands in parallel (true) or sequentially (false). Defaults to parallel for faster execution."


runs:
  using: composite
  steps:
  - id: remove_cruft
    name: Cruft removal
    run: |
      echo "Disk space before cruft removal"
      df -h
      if [[ -n "${{ inputs.to_remove }}" ]]; then
          TO_REMOVE=(${{ inputs.to_remove }})
      else
          TO_REMOVE=(${DEFAULT_DIRECTORIES})
      fi

      if [[ "${{ inputs.background }}" == "true" ]]; then
          # Run rm commands in background
          pids=()
          for removal in "${TO_REMOVE[@]}"; do
              echo "Removing: ${removal} (background) ..."
              sudo rm -rf "$removal" &
              pids+=($!)
          done
          # Wait for all background processes to complete
          failed=0
          for pid in "${pids[@]}"; do
              if ! wait "$pid"; then
                  failed=1
              fi
          done
          if [ "$failed" -eq 1 ]; then
              echo "Warning: One or more disk cleanup processes failed. Check previous output for specific errors."
          fi
      else
          # Run rm commands in foreground
          for removal in "${TO_REMOVE[@]}"; do
              echo "Removing: ${removal} ..."
              sudo rm -rf "$removal"
          done
      fi

      echo "Disk after cruft removal"
      df -h
    env:
      DEFAULT_DIRECTORIES: |
        /opt/hostedtoolcache
        /usr/local/lib/android
        /usr/local/.ghcup
    shell: bash
