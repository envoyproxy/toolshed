uses: ./gh-actions/gpg/sign
id: sign
with:
  fingerprint: >-
    %{{ env.GPG_FINGERPRINT }}
  path: /tmp/test-sign-no-pass-dir

before:
- shell: bash
  run: |
    . "${ACTION_TEST_PATH}/test_fun.sh"

    NAME="Test User No Pass"
    EMAIL="testnopass@example.com"

    # Generate test key without passphrase
    generate_test_key_no_passphrase "$NAME" "$EMAIL"

    # Get the fingerprint
    FINGERPRINT=$(gpg --list-secret-keys --with-colons "${EMAIL}" | \
        awk -F: '/^fpr:/ { print $10; exit }')

    echo "GPG_FINGERPRINT=${FINGERPRINT}" >> $GITHUB_ENV

    # Create test directory with files
    mkdir -p /tmp/test-sign-no-pass-dir
    echo "test file 1" > /tmp/test-sign-no-pass-dir/file1.txt
    echo "test file 2" > /tmp/test-sign-no-pass-dir/file2.txt

after:
- shell: bash
  run: |
    . "${ACTION_TEST_PATH}/test_fun.sh"

    FINGERPRINT='%{{ env.GPG_FINGERPRINT }}'

    test_signed_file_exists "/tmp/test-sign-no-pass-dir/checksums.txt.asc"
    test_checksums_file_exists "/tmp/test-sign-no-pass-dir/checksums.txt"
    test_signature_valid "/tmp/test-sign-no-pass-dir/checksums.txt.asc" "$FINGERPRINT"
    test_checksums_contain_files "/tmp/test-sign-no-pass-dir/checksums.txt" "file1.txt" "file2.txt"
