uses: ./gh-actions/gpg/sign
id: sign
with:
  fingerprint: >-
    %{{ env.GPG_FINGERPRINT }}
  passphrase: >-
    %{{ env.GPG_PASSWORD }}
  path: /tmp/test-sign-dir

before:
- shell: bash
  run: |
    . "${ACTION_TEST_PATH}/test_fun.sh"

    NAME="Test User"
    EMAIL="test@example.com"
    PASSPHRASE="testpassword123"

    # Generate and import test key
    generate_test_key "$NAME" "$EMAIL" "$PASSPHRASE"

    # Get the fingerprint
    FINGERPRINT=$(gpg --list-secret-keys --with-colons "${EMAIL}" | \
        awk -F: '/^fpr:/ { print $10; exit }')

    echo "GPG_FINGERPRINT=${FINGERPRINT}" >> $GITHUB_ENV
    echo "GPG_PASSWORD=${PASSPHRASE}" >> $GITHUB_ENV

    # Create test directory with files
    mkdir -p /tmp/test-sign-dir
    echo "test file 1" > /tmp/test-sign-dir/file1.txt
    echo "test file 2" > /tmp/test-sign-dir/file2.txt

after:
- shell: bash
  run: |
    . "${ACTION_TEST_PATH}/test_fun.sh"

    FINGERPRINT='%{{ env.GPG_FINGERPRINT }}'

    test_signed_file_exists "/tmp/test-sign-dir/checksums.txt.asc"
    test_checksums_file_exists "/tmp/test-sign-dir/checksums.txt"
    test_signature_valid "/tmp/test-sign-dir/checksums.txt.asc" "$FINGERPRINT"
    test_checksums_contain_files "/tmp/test-sign-dir/checksums.txt" "file1.txt" "file2.txt"
