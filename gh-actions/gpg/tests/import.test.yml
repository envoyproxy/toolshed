uses: ./gh-actions/gpg
id: gpg
with:
  gpg-key: >-
    %{{ secrets.GPG_KEY }}
  gpg-password: >-
    %{{ secrets.GPG_PASSWORD }}

after:
- shell: bash
  run: |
    FINGERPRINT='%{{ steps.gpg.outputs.fingerprint }}'
    PASSPHRASE='%{{ steps.gpg.outputs.passphrase }}'

    if [[ -z "$FINGERPRINT" ]]; then
        echo "fail:Fingerprint output is empty" >> "$TEST_OUTPUT"
    elif [[ ! "$FINGERPRINT" =~ ^[A-F0-9]{40}$ ]]; then
        echo "fail:Fingerprint format is invalid: $FINGERPRINT" >> "$TEST_OUTPUT"
    else
        echo "success:Fingerprint output is valid: $FINGERPRINT" >> "$TEST_OUTPUT"
    fi

    if [[ -z "$PASSPHRASE" ]]; then
        echo "fail:Passphrase output is empty" >> "$TEST_OUTPUT"
    else
        echo "success:Passphrase output is present" >> "$TEST_OUTPUT"
    fi

    # Verify the key exists and can be used
    if gpg --list-secret-keys | grep -q "$FINGERPRINT"; then
        echo "success:GPG key is in keyring" >> "$TEST_OUTPUT"
    else
        echo "fail:GPG key not found in keyring" >> "$TEST_OUTPUT"
    fi
