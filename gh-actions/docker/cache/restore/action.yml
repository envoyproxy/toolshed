inputs:
  image-tag:
    type: string
    required: true
  key-suffix:
    type: string
    required: true
  bind-mount:
    type: string
    default:
  mount-tmpfs:
    type: string
    default: true
  overwrite:
    type: boolean
    default: true

runs:
  using: "composite"
  steps:
  - uses: envoyproxy/toolshed/gh-actions/cache/restore@dae53641f31cf48b1bdf0e870d07535ab51c9098
    with:
      key: ${{ inputs.image-tag }}${{ inputs.key-suffix }}
      command: |
        systemctl stop docker docker.socket
        if mountpoint -q /var/lib/docker; then
            MOUNT_SOURCE=$(findmnt -n -o SOURCE --mountpoint /var/lib/docker)
            MOUNT_SOURCE=$(echo "$MOUNT_SOURCE" | sed -E 's/.*\[([^]]+)\].*/\1/')

            # TEMP WORKAROUND
            MOUNT_SOURCE=/mnt/docker

            umount /var/lib/docker
            if [[ -n "$MOUNT_SOURCE" && -d "$MOUNT_SOURCE" ]]; then
                mv "$MOUNT_SOURCE" "${MOUNT_SOURCE}.orig"
                mkdir -p "$MOUNT_SOURCE"
                mount -o bind "$MOUNT_SOURCE" /var/lib/docker
                echo "${MOUNT_SOURCE}.orig" > /tmp/NEEDS_DELETE
            else
                echo "Error: Detected mount source '$MOUNT_SOURCE' is invalid or not a directory."
                exit 1
            fi
        else
            mv /var/lib/docker /var/lib/docker.orig
            mkdir -p /var/lib/docker
            echo "/var/lib/docker.orig" > /tmp/NEEDS_DELETE
        fi
        if [[ -n "${{ inputs.bind-mount }}" ]]; then
            mkdir -p "${{ inputs.bind-mount }}"
            mount -o bind "${{ inputs.bind-mount }}" /var/lib/docker
        fi
        zstd --stdout -d docker.tar.zst | tar -xf - -C /var/lib/docker
        systemctl start docker
      mount-tmpfs: ${{ inputs.mount-tmpfs }}
      run-as-sudo: true
  - if: >-
      fromJSON(inputs.overwrite)
    run: |
      TO_DELETE="$(sudo cat /tmp/NEEDS_DELETE)"
      sudo rm -rf ${TO_DELETE} &
    shell: bash
