inputs:
  name:
    type: string
    required: true
  repository:
    type: string
    required: true
    default: ${{ github.repository }}
  token:
    # requires: `actions: read`
    type: string
    required: true
    default: ${{ github.token }}

outputs:
  id:
    value: ${{ steps.cache-id.outputs.id }}


runs:
  using: composite
  steps:
  - id: cache-id
    shell: bash
    run: |
      # Fetch up to 10 recent artifacts with matching name
      artifacts=$(gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "/repos/${REPOSITORY}/actions/artifacts?name=${ARTIFACT_NAME}&per_page=10" \
          --jq '.artifacts[] | "\(.id) \(.workflow_run.id)"')

      artifact_id=""
      while IFS=' ' read -r aid wfid; do
        if [[ -z "$aid" ]]; then
          continue
        fi

        # Get workflow run details to validate
        workflow_data=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${REPOSITORY}/actions/runs/${wfid}" \
            --jq '{path: .path, event: .event}')

        path=$(echo "$workflow_data" | jq -r '.path')
        event=$(echo "$workflow_data" | jq -r '.event')

        # Validate: must be request.yml workflow and not a pull_request event
        if [[ "$path" == ".github/workflows/request.yml" && "$event" != "pull_request" ]]; then
          artifact_id="$aid"
          break
        else
          echo "::warning::Skipping artifact ${aid} from workflow ${path} (event: ${event})" >&2
        fi
      done <<< "$artifacts"

      echo "id=${artifact_id}" >> $GITHUB_OUTPUT
    env:
      ARTIFACT_NAME: ${{ inputs.name }}.tar.zst
      GH_TOKEN: ${{ inputs.token }}
      REPOSITORY: ${{ inputs.repository }}
