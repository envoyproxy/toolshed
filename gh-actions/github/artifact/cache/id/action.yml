inputs:
  name:
    type: string
    required: true
  repository:
    type: string
    required: true
    default: ${{ github.repository }}
  token:
    # requires: `actions: read`
    type: string
    required: true
    default: ${{ github.token }}

outputs:
  id:
    value: ${{ steps.cache-id.outputs.id }}


runs:
  using: composite
  steps:
  - id: cache-id
    shell: bash
    run: |
      # Fetch up to 10 recent artifacts with matching name
      # Limit to 10 to detect cache poisoning - if >10 artifacts exist, fail rather than risk using a malicious one
      # Only select artifacts from main branch or release branches (release/v*)
      artifact_id=$(gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "/repos/${REPOSITORY}/actions/artifacts?name=${ARTIFACT_NAME}&per_page=10" \
          --jq "${JQ_FILTER}")
      echo "id=${artifact_id}" >> $GITHUB_OUTPUT
    env:
      ARTIFACT_NAME: ${{ inputs.name }}.tar.zst
      GH_TOKEN: ${{ inputs.token }}
      JQ_FILTER: |
        [.artifacts[] |
          select((.workflow_run.head_branch == "main" or
                  (.workflow_run.head_branch | startswith("release/v"))) and
                 .workflow_run.repository_id == .workflow_run.head_repository_id)
        ][0] | .id // empty
      REPOSITORY: ${{ inputs.repository }}
