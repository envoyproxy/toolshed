
inputs:
  id:
    type: string
    required: true
  data:
    type: string
    required: true
  repository:
    type: string
    default: ${{ github.repository }}
  template-script-current:
    type: string
    default: |
      # Find current check (\($name)) for run attempt (\($attempt))
      RESPONSE=\"$(gh api repos/\($repo)/commits/\($head_sha)/check-runs?status=in_progress&status=queued&check_name=\($name)&filter=latest)\"
      echo \"output=$RESPONSE\" >> $GITHUB_OUTPUT
  template-script-update:
    type: string
    default: |
      # Update check (\($name))
      CHECK=\($check)
      RESPONSE=\"$(echo $CHECK | gh api -XPATCH --input - repos/\($repo)/check-runs/\($id))\"
      echo \"output=$RESPONSE\" >> $GITHUB_OUTPUT
  token:
    type: string
    default: ${{ github.token }}

outputs:
  checks:
    value: ${{ steps.checks.outputs.value }}


runs:
  using: composite
  steps:
  # If the original check is already completed, we have been retested and we need to find the real one
  - uses: envoyproxy/toolshed/gh-actions/bson@actions-v0.1.75
    name: Find check
    if: ${{ fromJSON(inputs.data).status == 'completed' && github.run_attempt > 1 }}
    id: current-checks
    with:
      input: ${{ inputs.data }}
      filter: |
        ${{ github.run_attempt }} as $attempt
        | "${{ inputs.repository }}" as $repo
        | .name as $name
        | .head_sha as $head_sha
        | "${{ inputs.template-script-current }}"
    env:
      GH_TOKEN: ${{ inputs.token }}
  - name: Progress status check
    uses: envoyproxy/toolshed/gh-actions/bson@actions-v0.1.75
    with:
      input: ${{ inputs.data }}
      filter: |
        .
        | ${{ inputs.id }} as $id
        | .name as $name
        | "${{ inputs.repository }}" as $repo
        | ${{ steps.current-checks.outputs.output || 'null' }} as $current
        | if $current != null then
            .id = $current.check_runs[0].id
          else
            .id = $id
          end
        | .id as $id
        | tojson
        | @sh as $check
        | "${{ inputs.template-script-update }}"
    env:
      GH_TOKEN: ${{ inputs.token }}
  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.75
    name: Print check response
    id: checks
    with:
      input: ${{ steps.progress.outputs.output }}
      print-result: ${{ fromJSON(env.CI_DEBUG || 'false') && true || false }}
