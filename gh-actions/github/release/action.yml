inputs:
  dry-run:
    type: boolean
    default: true
  fail-if-exists:
    type: boolean
    default: true
  name:
    type: string
    required: true
  repository:
    type: string
    required: true
  sha:
    type: string
    required: true
  template-release:
    type: string
    default: |
      export RELEASE_ARGS='\($release_args)'
      export TAG='\($tag)'
      export REPO='\(.repo)'
      export FAIL_IF_EXISTS='\(.fail_if_exists)'
      export DRY_RUN='\(.dry_run)'
      export NEXT_VERSION='\($next_version)'
      export VERSION_FILE='\(.version_file)'
      export REOPEN_MESSAGE='\($reopen_message)'
      OUTPUT=$(${RELEASE_ACTION_PATH}/release.sh)
  token:
    type: string
    required: true
  version:
    type: string
    required: true
  version-file:
    type: string
    required: true

outputs:
  result:
    value: ${{ steps.release.outputs.output }}


runs:
  using: composite
  steps:
  - uses: envoyproxy/toolshed/gh-actions/bson@32aeb5acdf19691c6057ae45a4e1ef9617087996
    id: release
    env:
      GH_TOKEN: ${{ inputs.token }}
      RELEASE_ACTION_PATH: ${{ github.action_path }}
    with:
      input: |
        dry_run: ${{ inputs.dry-run }}
        fail_if_exists: ${{ inputs.fail-if-exists }}
        name: ${{ inputs.name }}
        repo: ${{ inputs.repository }}
        sha: ${{ inputs.sha }}
        version: ${{ inputs.version }}
        version_file: ${{ inputs.version-file }}
      filter: |
        .
        | .version.version as $version
        | .version.next as $next_version
        | "\(.name)-v\($version)" as $tag
        | (.name | "\(.[0:1] | ascii_upcase)\(.[1:])") as $title
        | "repo: Dev \($title) v\($next_version)" as $reopen_message
        | (["\"\($tag)\"",
            "--target \"\(.sha)\"",
            "--title \"\($tag)\"",
            "--notes \"\($title) release \($version)\"",
            "--repo \"\(.repo)\""]
           | join(" ")) as $release_args
        | "${{ inputs.template-release }}"
        | bash::output
      options: -r
      result-filter-options: -sRc
      result-filter: |
        .
        | split("\n")
