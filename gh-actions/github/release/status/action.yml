inputs:
  commit-message:
    required: true
    type: string
  event:
    type: string
    required: true
  name:
    type: string
    required: true
  repository:
    type: string
    default: ${{ github.repository }}
  sha:
    type: string
    required: true
  template-pr-link:
    type: string
    default: >-
      ([PR #\($pr.number)](https://github.com/\($repo)/pull/\($pr.number)))
  template-status:
    type: string
    default: |
      ## Publish (\(.name)): `\(.event)` \($release_info)

      ### \($title)

      **Commit:** [\($sha[0:7])](https://github.com/\($repo)/commit/\($sha)) \($pr_link)
      **Continue:** `\(.continue)`


  version:
    type: string
    default:
  version-file:
    type: string
    required: true
  workflows:
    type: string
    required: true

outputs:
  continue:
    value: ${{ steps.afterall.outputs.continue }}
  run-ids:
    value: ${{ steps.afterall.outputs.run-ids }}
  version:
    value: ${{ steps.version.outputs.version }}


runs:
  using: composite
  steps:
  - name: Check all workflows ran
    id: afterall
    uses: envoyproxy/toolshed/gh-actions/github/afterall@64d95bf651f750701fc23603a81cd512d9f5997d
    with:
      sha: ${{ inputs.sha }}
      workflows: ${{ inputs.workflows }}
      repo: ${{ inputs.repository }}
  - name: Commit messsage (for PR or branch)
    id: commit-message
    uses: envoyproxy/toolshed/gh-actions/jq@64d95bf651f750701fc23603a81cd512d9f5997d
    with:
      options: -sRr
      input: |
        ${{ inputs.commit-message }}
      filter: |
        split("\n") | first
  - name: Version info
    id: version
    uses: envoyproxy/toolshed/gh-actions/version@64d95bf651f750701fc23603a81cd512d9f5997d
    with:
      version: ${{ inputs.version }}
      version-file: ${{ inputs.version-file }}
  - name: Status summary title
    id: status-summary-title
    uses: envoyproxy/toolshed/gh-actions/jq@64d95bf651f750701fc23603a81cd512d9f5997d
    with:
      input: |
        event: ${{ inputs.event }}
        sha: ${{ inputs.sha }}
        continue: ${{ steps.afterall.outputs.continue }}
        name: ${{ inputs.name }}
        repository: ${{ inputs.repository }}
        pr: ${{ github.event.workflow_run.event }}
        commit_message: |
          ${{ steps.commit-message.outputs.value }}
        version: ${{ steps.version.outputs.version }}
      input-format: yaml
      options: -r
      output-path: GITHUB_STEP_SUMMARY
      filter: |
        .sha as $sha
        | .repository as $repo
        | (if .version.is_dev then ""
           else "release: \(.name)-v\(.version.version)"
           end) as $release_info
        | (if .event == "pull_request" and .pr != null and .pr != "{}" and .pr != "" then
             .pr
             | if type == "object" then .
               else fromjson end
           else {} end) as $pr
        | (if $pr.number then
             $pr.title // "PR #\($pr.number)"
           else .commit_message
           end) as $title
        | (if $pr.number then
             "${{ inputs.template-pr-link }}"
           else ""
           end) as $pr_link
        | "${{ inputs.template-status }}"
  - name: Versions info
    uses: envoyproxy/toolshed/gh-actions/json/table@64d95bf651f750701fc23603a81cd512d9f5997d
    with:
      append: true
      output-path: GITHUB_STEP_SUMMARY
      collapse: false
      input: |
        name: ${{ inputs.name }}
        version: ${{ steps.version.outputs.version }}
      headers:
      input-format: yaml
      filter: |
        .
        | (if .version.is_dev then ""
           else "**(RELEASE)**"
           end) as $release
        | {
            "\(.name) version": "\(.version.version) \($release)",
          }
  - name: Generate workflow status table
    uses: envoyproxy/toolshed/gh-actions/json/table@64d95bf651f750701fc23603a81cd512d9f5997d
    with:
      title: Required Workflows Status
      append: true
      output-path: GITHUB_STEP_SUMMARY
      collapse-open: ${{ ! fromJSON(steps.afterall.outputs.continue) }}
      headers: |
        Workflow
        Status/conclusion
      input: |
        ${{ steps.afterall.outputs.status }}
      filter: |
        . as $data
        | (.status | fromjson) as $status
        | ($data["run-ids"] | fromjson) as $runIds
        | "${{ inputs.workflows }}" | split("\n") | map(select(length > 0)) as $workflows
        | ${{ toJSON(inputs.repository) }} as $repo
        | $workflows
        | map(
            . as $wf
            | if $status[$wf] then
                $status[$wf] as $st
                | ($st.conclusion // "pending") as $conclusion
                | {key: "[\($wf) (#\($st.id))](https://github.com/\($repo)/actions/runs/\($st.id))",
                   value: "`\($st.status)`/`\($conclusion)`"}
              else
                {key: $wf, value: "-"}
              end
          )
        | from_entries
