inputs:
  args:
    type: string
  command:
    type: string
    required: true
  container-command:
    type: string
    default:
  container-output:
    type: string
    default:
  context:
    type: string
  catch-errors:
    type: boolean
    default: false
  diskspace-hack:
    type: boolean
    default: false
  diskspace-hack-paths:
    type: string
    default:
  downloads:
    type: string
    default:
  error-match:
    type: string
    default: |
      ERROR
      error:
      Error:
  notice-match:
    type: string
    default: |
      NOTICE
  report-pre:
    type: string
    default: |
      - run: |
          echo "disk space at beginning of build:"
          df -h
        shell: bash
  report-post:
    type: string
    default: |
      - run: |
          echo "disk space at end of build:"
          df -h
        shell: bash
  source:
    type: string
  summary-post:
    type: string
    default:
  steps-pre:
    type: string
    default:
  steps-pre-name:
    type: string
    default:
  steps-post:
    type: string
    default:
  steps-post-name:
    type: string
    default:
  upload-name:
    type: string
    default:
  upload-path:
    type: string
    default:
  warning-match:
    type: string
    default: |
      WARNING
      warning:
      Warning:
  working-directory:
    type: string
    default: .

outputs:
  command:
    value: ${{ steps.command.outputs.actual }}
  completed:
    value: ${{ steps.completed.outputs.value }}
  container-command:
    value: ${{ steps.command.outputs.container-command }}
  exit-code:
    value: ${{ steps.run.outputs.exit-code }}
  started:
    value: ${{ steps.started.outputs.value }}


runs:
  using: composite
  steps:
  - if: ${{ fromJSON(inputs.diskspace-hack) }}
    name: Free diskspace
    uses: envoyproxy/toolshed/gh-actions/diskspace@actions-v0.1.65
    with:
      to_remove: ${{ inputs.diskskpack-hack-paths }}
  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.65
    name: Generate download config
    if: ${{ inputs.downloads }}
    id: download-config
    with:
      input: ${{ inputs.downloads }}
      input-format: yaml
  - uses: envoyproxy/toolshed/gh-actions/foreach@actions-v0.1.65
    if: ${{ steps.download-config.outputs.value }}
    with:
      items: ${{ steps.download-config.outputs.value }}
      steps: |
        - uses: actions/download-artifact@v3
          with:
            name: $KEY
            path: >-
              "%{{ fromJSON(inputs.context).items['$KEY'] }}"

  - run: |
      echo "DEBUG: RUN ${COMMAND}" >&2
      if [[ -e "$TMP_SOURCE" ]]; then
          cat $TMP_SOURCE
      fi
    if: ${{ env.CI_DEBUG || env.RUNNER_DEBUG }}
    env:
      COMMAND: ${{ steps.command.outputs.command }}
    shell: bash

  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.65
    name: Generate run context (steps-pre)
    id: context-steps-pre
    with:
      input: ${{ inputs.steps-pre || '""' }}
      options: -Rs
      input-format: string
  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.65
    name: Generate run context (steps-post)
    id: context-steps-post
    with:
      input: ${{ inputs.steps-post || '""' }}
      options: -Rs
      input-format: string
  - uses: envoyproxy/toolshed/gh-actions/using/steps@actions-v0.1.65
    name: Pre report
    if: ${{ inputs.report-pre }}
    with:
      steps: ${{ inputs.report-pre }}
      context: ${{ inputs.context }}
  - uses: envoyproxy/toolshed/gh-actions/using/steps@actions-v0.1.65
    name: Run pre steps
    if: ${{ inputs.steps-pre }}
    with:
      name: ${{ inputs.steps-pre-name }}
      steps: ${{ inputs.steps-pre }}
      context: ${{ inputs.context }}

  - run: |
      # Put the command and args together
      COMMAND=()
      read -ra ARGS <<< "${{ inputs.args }}"
      ACTUAL_COMMAND=(
          ${{ inputs.command }}
          ${ARGS[@]})
      # allow mangling of command in presteps
      if [[ "${#CONTAINER_COMMAND}" -ne 0 ]]; then
          read -ra ACTUAL_CONTAINER_COMMAND <<< "${CONTAINER_COMMAND}"
      else
          read -ra ACTUAL_CONTAINER_COMMAND <<< "${{ inputs.container-command }}"
      fi
      COMMAND+=("${ACTUAL_CONTAINER_COMMAND[@]}")
      COMMAND+=("${ACTUAL_COMMAND[@]}")
      echo "container=${ACTUAL_CONTAINER_COMMAND[*]}" >> $GITHUB_OUTPUT
      echo "CONTAINER_COMMAND=${ACTUAL_CONTAINER_COMMAND[*]}" >> $GITHUB_ENV
      echo "actual=${ACTUAL_COMMAND[*]}" >> $GITHUB_OUTPUT
      echo "command=${COMMAND[*]}" >> $GITHUB_OUTPUT
    id: command
    shell: bash

  - run: |
      if [[ "${#INPUT_ENV}" -ne 0 ]]; then
          SOURCETMP="$(mktemp)"
          echo "TMP_SOURCE=${SOURCETMP}" >> $GITHUB_ENV
          echo "source=${SOURCETMP}" >> $GITHUB_OUTPUT
      fi
      echo "TMP_STDERR=$(mktemp)" >> $GITHUB_ENV
      echo "TMP_STDOUT=$(mktemp)" >> $GITHUB_ENV

    id: paths
    env:
      INPUT_ENV: ${{ inputs.source }}
    shell: bash

  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.65
    if: ${{ inputs.source }}
    id: source
    with:
      input: |
        ${{ inputs.source }}
      options: -Rsr
      output-path: ${{ steps.paths.output.source }}

  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.65
    if: ${{ always() }}
    id: started
    with:
      options: -r
      filter: now
  - run: |
      cd $TARGET_PATH
      if [[ -n "${TMP_SOURCE}" ]]; then
          . "$TMP_SOURCE"
      fi
      echo "stderr-path=${TMP_STDERR}" >> $GITHUB_OUTPUT
      echo "stdout-path=${TMP_STDOUT}" >> $GITHUB_OUTPUT
      read -ra COMMAND_PARTS <<< "$COMMAND"
      EXIT_CODE=0
      "${COMMAND_PARTS[@]}" > >(tee "$TMP_STDOUT") 2> >(tee "$TMP_STDERR") || {
          EXIT_CODE=$?
      }
      echo "exit-code=${EXIT_CODE}" >> $GITHUB_OUTPUT
    shell: bash
    id: run
    env:
      COMMAND: ${{ steps.command.outputs.command }}
      TARGET_PATH: ${{ inputs.working-directory }}
  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.65
    id: cancelled
    if: ${{ cancelled() }}
    with:
      options: -r
      filter: |
        true
  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.65
    if: ${{ always() }}
    id: completed
    with:
      options: -r
      filter: now
  - run: |
      STDERR="$(cat "$TMP_STDERR")"
      bubble_messages () {
          local message_type="$1" \
                matcher="$2" \
                matches=()
          matcher=${matcher%"${matcher##*[![:space:]]}"}
          while IFS=$'\n' read -r line; do
              matches+=("$line")
          done <<< "$matcher"
          declare -a issued_warnings
          for match in "${matches[@]}"; do
              matched="$(echo "${STDERR}" | grep "$match" || :)"
              if [[ -z "$matched" ]]; then
                  continue
              fi
              while read -r message; do
                  found=0
                  for issued in "${issued_warnings[@]}"; do
                      if [[ "$issued" == "$message" ]]; then
                          found=1
                          break
                      fi
                  done
                  if [[ $found -ne 0 ]]; then
                      continue
                  fi
                  issued_warnings+=("$message")
                  echo "::${message_type}::${message}"
              done < <(echo "$matched" | grep -o ".*" || :)
          done
      }
      bubble_messages error "${{ inputs.error-match }}"
      bubble_messages warning "${{ inputs.warning-match }}"
      bubble_messages notice "${{ inputs.notice-match }}"
    shell: bash
    if: ${{ ! (cancelled() || fromJSON(steps.cancelled.outputs.value || 'false')) }}

  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.65
    name: Generate run context
    id: context
    if: ${{ always() }}
    with:
      input: ${{ toJSON(steps.run.outputs) }}
      filter: >-
        . * {"started": ${{ steps.started.outputs.value }},
             "cancelled": ${{ steps.cancelled.outputs.value || 'false' }},
             "container-command": "${{ steps.command.outputs.container }}",
             "command": "${{ steps.command.outputs.actual }}",
             "completed": ${{ steps.completed.outputs.value }},
             "steps-pre": ${{ steps.context-steps-pre.outputs.value }},
             "steps-post": ${{ steps.context-steps-post.outputs.value }},
             "exit-code": (.["exit-code"] // "0" | fromjson)}
        | {"run": .,
           "context": ${{ inputs.context }}}

  - if: ${{ inputs.container-output && ( ! (cancelled() || fromJSON(steps.cancelled.outputs.value || 'false'))) }}
    uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.65
    id: bins
    with:
      input: ${{ inputs.container-output }}
      input-format: yaml
      print-output: true
      options: -r
      filter: |
        .
        | to_entries
        | map("mkdir -p $(dirname \(.value))\n\(env.CONTAINER_COMMAND) cat \(.key)  > \(.value)")
        | join("\n")
  - if: ${{ inputs.container-output && ( ! (cancelled() || fromJSON(steps.cancelled.outputs.value || 'false'))) }}
    run: ${{ steps.bins.outputs.value }}
    shell: bash

  - uses: envoyproxy/toolshed/gh-actions/using/steps@actions-v0.1.65
    name: Run post steps
    if: ${{ inputs.steps-post && ! (fromJSON(steps.context.outputs.value).run.cancelled || cancelled()) }}
    with:
      name: ${{ inputs.steps-post-name }}
      steps: ${{ inputs.steps-post }}
      context: ${{ steps.context.outputs.value }}
  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.65
    id: post-failed
    if: ${{ failure() && inputs.upload-name && inputs.upload-path }}
    with:
      input: ${{ steps.context.outputs.value }}
      filter: |
        .run["post-steps-failed"] = true
  - uses: envoyproxy/toolshed/gh-actions/using/steps@actions-v0.1.65
    name: Post report
    if: ${{ inputs.report-post && ! (fromJSON(steps.context.outputs.value).run.cancelled || cancelled()) }}
    with:
      steps: ${{ inputs.report-post }}
      context: ${{ steps.context.outputs.value }}
  - uses: actions/upload-artifact@v3
    name: Upload artefacts
    if: ${{ inputs.upload-name && inputs.upload-path && ! (fromJSON(steps.context.outputs.value).run.cancelled || cancelled()) }}
    with:
      name: ${{ inputs.upload-name }}
      path: ${{ inputs.upload-path }}
  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.65
    id: upload-failed
    if: ${{ failure() && inputs.upload-name && inputs.upload-path }}
    with:
      input: ${{ steps.post-failed.outputs.value || steps.context.outputs.value }}
      filter: |
        .run["upload-failed"] = true
  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.65
    id: run-cancelled
    if: ${{ cancelled() }}
    with:
      input: ${{ steps.post-failed.outputs.value || steps.context.outputs.value }}
      filter: |
        .run["cancelled"] = true
  - uses: envoyproxy/toolshed/gh-actions/using/steps@actions-v0.1.65
    name: Job summary
    if: ${{ always() && inputs.summary-post }}
    with:
      steps: ${{ inputs.summary-post }}
      context: ${{ steps.upload-failed.outputs.value || steps.post-failed.outputs.value || steps.context.outputs.value }}
  - run: |
      rm -rf "$TMP_STDOUT"
      rm -rf "$TMP_STDERR"
      if [[ -n "$TMP_SOURCE" && -e "$TMP_SOURCE" ]]; then
          rm -rf "$TMP_SOURCE"
      fi
      if [[ -n "${CANCELLED}" ]]; then
          # Unfortunately theres no way to indicate that the job was cancelled without it also
          # then showing the entire workflow as cancelled, despite the cancellation happening
          # due to failure
          echo "Run cancelled" >&2
          exit 0
      elif [[ "${EXIT_CODE}" -ne 0 ]]; then
          echo "Run failed" >&2
          exit ${EXIT_CODE}
      elif [[ -n "${STEPS_POST_ERR}" ]]; then
          echo "Post steps failed" >&2
          echo "::error::Post steps failed" >&2
          exit 1
      elif [[ -n "${UPLOAD_ERR}" ]]; then
          echo "Upload failed" >&2
          echo "::error::Upload failed" >&2
          exit 1
      fi
      exit ${EXIT_CODE}
    shell: bash
    if: ${{ always() }}
    env:
      EXIT_CODE: ${{ !fromJSON(inputs.catch-errors) && steps.run.outputs.exit-code || 0 }}
      CANCELLED: ${{ steps.cancelled.outputs.value != '' && true || '' }}
      STEPS_POST_ERR: ${{ steps.post-failed.outputs.value != '' && true || '' }}
      UPLOAD_ERR: ${{ steps.upload-failed.outputs.value != '' && true || '' }}
