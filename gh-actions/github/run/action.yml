
inputs:
  command:
    type: string
    required: true
  args:
    type: string
  container-command:
    type: string
    default:
  catch-errors:
    type: boolean
    default: false
  diskspace-hack:
    type: boolean
    default: false
  diskspace-hack-paths:
    type: string
    default:
  error-match:
    type: string
    default: |
      ERROR
      error:
      Error:
  notice-match:
    type: string
    default: |
      NOTICE
  report-pre:
    type: string
    default: |
      - run: |
          echo "disk space at beginning of build:"
          df -h
        shell: bash
  report-post:
    type: string
    default: |
      - run: |
          echo "disk space at end of build:"
          df -h
        shell: bash
  steps-pre:
    type: string
    default:
  steps-pre-name:
    type: string
    default:
  steps-post:
    type: string
    default:
  steps-post-name:
    type: string
    default:
  upload-name:
    type: string
    default:
  upload-path:
    type: string
    default:
  warning-match:
    type: string
    default: |
      WARNING
      warning:
      Warning:

  source:
    type: string


runs:
  using: composite
  steps:
  - if: ${{ fromJSON(inputs.diskspace-hack) }}
    name: Free diskspace
    uses: envoyproxy/toolshed/gh-actions/diskspace@actions-v0.1.21
    with:
      to_remove: ${{ inputs.diskskpack-hack-paths }}
  - uses: envoyproxy/toolshed/gh-actions/using/steps@actions-v0.1.21
    name: Pre report
    if: ${{ inputs.report-pre }}
    with:
      steps: ${{ inputs.report-pre }}
  - uses: envoyproxy/toolshed/gh-actions/using/steps@actions-v0.1.21
    name: Run pre steps
    if: ${{ inputs.steps-pre }}
    with:
      name: ${{ inputs.steps-pre-name }}
      steps: ${{ inputs.steps-pre }}
  - run: |
      if [[ "${#INPUT_ENV}" -ne 0 ]]; then
          SOURCETMP="$(mktemp)"
          # TODO(phlax): Fix escaping
          printf "%s" '${{ inputs.source }}' > "$SOURCETMP"
          . "$SOURCETMP"
          rm -rf "$SOURCETMP"
      fi
      COMMAND=()
      read -ra ARGS <<< "${{ inputs.args }}"
      ACTUAL_COMMAND=(
          ${{ inputs.command }}
          ${ARGS[@]})
      # allow mangling of command in presteps
      if [[ "${#CONTAINER_COMMAND}" -ne 0 ]]; then
          COMMAND+=(${CONTAINER_COMMAND})
      else
          COMMAND+=(${{ inputs.container-command }})
      fi
      COMMAND+=("${ACTUAL_COMMAND[@]}")
      TMP_OUTPUT=$(mktemp)
      if [[ -n "$RUNNER_DEBUG" || -n "$CI_DEBUG" ]]; then
          echo "DEBUG: RUN ${COMMAND[*]}" >&2
      fi
      "${COMMAND[@]}" 2> >(tee "$TMP_OUTPUT") || {
          FAILED=true
      }
      OUTPUT="$(cat "$TMP_OUTPUT")"
      rm -rf "$TMP_OUTPUT"

      bubble_messages () {
          local message_type="$1" \
                matcher="$2" \
                matches=()
          matcher=${matcher%"${matcher##*[![:space:]]}"}
          while IFS=$'\n' read -r line; do
              matches+=("$line")
          done <<< "$matcher"
          declare -a issued_warnings
          for match in "${matches[@]}"; do
              matched="$(echo "$OUTPUT" | grep "$match" || :)"
              if [[ -z "$matched" ]]; then
                  continue
              fi
              while read -r message; do
                  found=0
                  for issued in "${issued_warnings[@]}"; do
                      if [[ "$issued" == "$message" ]]; then
                          found=1
                          break
                      fi
                  done
                  if [[ $found -ne 0 ]]; then
                      continue
                  fi
                  issued_warnings+=("$message")
                  echo "::${message_type}::${message}"
              done < <(echo "$matched" | grep -o ".*" || :)
          done
      }
      bubble_messages error "${{ inputs.error-match }}"
      bubble_messages warning "${{ inputs.warning-match }}"
      bubble_messages notice "${{ inputs.notice-match }}"
      if [[ -n "$FAILED" && "${{ inputs.catch-errors }}" != "true" ]]; then
          exit 1
      fi
    shell: bash
    env:
      INPUT_ENV: ${{ inputs.source }}
  - uses: envoyproxy/toolshed/gh-actions/using/steps@actions-v0.1.21
    name: Run post steps
    if: ${{ inputs.steps-post }}
    with:
      name: ${{ inputs.steps-post-name }}
      steps: ${{ inputs.steps-post }}
  - uses: envoyproxy/toolshed/gh-actions/using/steps@actions-v0.1.21
    name: Post report
    if: ${{ inputs.report-post }}
    with:
      steps: ${{ inputs.report-post }}
  - uses: actions/upload-artifact@v3
    name: Upload artefacts
    if: ${{ inputs.upload-name && inputs.upload-path }}
    with:
      name: ${{ inputs.upload-name }}
      path: ${{ inputs.upload-path }}
