inputs:
  command:
    type: string
    required: true
  args:
    type: string
  container-command:
    type: string
    default:
  context:
    type: string
  catch-errors:
    type: boolean
    default: false
  diskspace-hack:
    type: boolean
    default: false
  diskspace-hack-paths:
    type: string
    default:
  error-match:
    type: string
    default: |
      ERROR
      error:
      Error:
  notice-match:
    type: string
    default: |
      NOTICE
  report-pre:
    type: string
    default: |
      - run: |
          echo "disk space at beginning of build:"
          df -h
        shell: bash
  report-post:
    type: string
    default: |
      - run: |
          echo "disk space at end of build:"
          df -h
        shell: bash
  source:
    type: string
  summary-post:
    type: string
    default:
  steps-pre:
    type: string
    default:
  steps-pre-name:
    type: string
    default:
  steps-post:
    type: string
    default:
  steps-post-name:
    type: string
    default:
  upload-name:
    type: string
    default:
  upload-path:
    type: string
    default:
  warning-match:
    type: string
    default: |
      WARNING
      warning:
      Warning:
  working-directory:
    type: string
    default: .

outputs:
  command:
    value: ${{ steps.command.outputs.actual }}
  completed:
    value: ${{ steps.completed.outputs.timestamp }}
  container-command:
    value: ${{ steps.command.outputs.container-command }}
  exit-code:
    value: ${{ steps.run.outputs.exit-code }}
  started:
    value: ${{ steps.started.outputs.timestamp }}


runs:
  using: composite
  steps:
  - if: ${{ fromJSON(inputs.diskspace-hack) }}
    name: Free diskspace
    uses: envoyproxy/toolshed/gh-actions/diskspace@actions-v0.1.57
    with:
      to_remove: ${{ inputs.diskskpack-hack-paths }}
  - uses: envoyproxy/toolshed/gh-actions/using/steps@actions-v0.1.57
    name: Pre report
    if: ${{ inputs.report-pre }}
    with:
      steps: ${{ inputs.report-pre }}
      context: ${{ inputs.context }}
  - uses: envoyproxy/toolshed/gh-actions/using/steps@actions-v0.1.57
    name: Run pre steps
    if: ${{ inputs.steps-pre }}
    with:
      name: ${{ inputs.steps-pre-name }}
      steps: ${{ inputs.steps-pre }}
      context: ${{ inputs.context }}
  - run: |
      if [[ "${#INPUT_ENV}" -ne 0 ]]; then
          SOURCETMP="$(mktemp)"
          # TODO(phlax): Fix escaping
          printf "%s" '${{ inputs.source }}' > "$SOURCETMP"
      fi
      echo "file=${SOURCETMP}" >> $GITHUB_OUTPUT
    if: ${{ inputs.source }}
    id: source
    env:
      INPUT_ENV: ${{ inputs.source }}
    shell: bash

  - run: |
      # Put the command and args together
      COMMAND=()
      read -ra ARGS <<< "${{ inputs.args }}"
      ACTUAL_COMMAND=(
          ${{ inputs.command }}
          ${ARGS[@]})
      # allow mangling of command in presteps
      if [[ "${#CONTAINER_COMMAND}" -ne 0 ]]; then
          read -ra ACTUAL_CONTAINER_COMMAND <<< "${CONTAINER_COMMAND}"
      else
          read -ra ACTUAL_CONTAINER_COMMAND <<< "${{ inputs.container-command }}"
      fi
      COMMAND+=("${ACTUAL_CONTAINER_COMMAND[@]}")
      COMMAND+=("${ACTUAL_COMMAND[@]}")
      echo "container=${ACTUAL_CONTAINER_COMMAND[*]}" >> $GITHUB_OUTPUT
      echo "actual=${ACTUAL_COMMAND[*]}" >> $GITHUB_OUTPUT
      echo "command=${COMMAND[*]}" >> $GITHUB_OUTPUT
    id: command
    shell: bash

  - run: |
      echo "DEBUG: RUN ${COMMAND}" >&2
      if [[ -e "$SOURCETMP" ]]; then
          cat $SOURCETMP
      fi
    if: ${{ env.CI_DEBUG || env.RUNNER_DEBUG }}
    env:
      COMMAND: ${{ steps.command.outputs.command }}
      SOURCETMP: ${{ steps.source.outputs.file }}
    shell: bash

  - uses: envoyproxy/toolshed/gh-actions/date@actions-v0.1.57
    id: started
  - run: |
      cd $TARGET_PATH
      if [[ -n "${SOURCETMP}" ]]; then
          . "$SOURCETMP"
          rm -rf "$SOURCETMP"
      fi
      TMP_STDERR=$(mktemp)
      echo "stderr-path=${TMP_STDERR}" >> $GITHUB_OUTPUT
      TMP_STDOUT=$(mktemp)
      echo "stdout-path=${TMP_STDOUT}" >> $GITHUB_OUTPUT
      read -ra COMMAND_PARTS <<< "$COMMAND"
      EXIT_CODE=0
      "${COMMAND_PARTS[@]}" > >(tee "$TMP_STDOUT") 2> >(tee "$TMP_STDERR") || {
          EXIT_CODE=$?
      }
      echo "exit-code=${EXIT_CODE}" >> $GITHUB_OUTPUT
    shell: bash
    id: run
    env:
      COMMAND: ${{ steps.command.outputs.command }}
      SOURCETMP: ${{ steps.source.outputs.file }}
      TARGET_PATH: ${{ inputs.working-directory }}
  - uses: envoyproxy/toolshed/gh-actions/date@actions-v0.1.57
    id: completed

  - run: |
      STDERR="$(cat "$TMP_STDERR")"
      bubble_messages () {
          local message_type="$1" \
                matcher="$2" \
                matches=()
          matcher=${matcher%"${matcher##*[![:space:]]}"}
          while IFS=$'\n' read -r line; do
              matches+=("$line")
          done <<< "$matcher"
          declare -a issued_warnings
          for match in "${matches[@]}"; do
              matched="$(echo "${STDERR}" | grep "$match" || :)"
              if [[ -z "$matched" ]]; then
                  continue
              fi
              while read -r message; do
                  found=0
                  for issued in "${issued_warnings[@]}"; do
                      if [[ "$issued" == "$message" ]]; then
                          found=1
                          break
                      fi
                  done
                  if [[ $found -ne 0 ]]; then
                      continue
                  fi
                  issued_warnings+=("$message")
                  echo "::${message_type}::${message}"
              done < <(echo "$matched" | grep -o ".*" || :)
          done
      }
      bubble_messages error "${{ inputs.error-match }}"
      bubble_messages warning "${{ inputs.warning-match }}"
      bubble_messages notice "${{ inputs.notice-match }}"
    shell: bash
    env:
      TMP_STDERR: ${{ steps.run.outputs.stderr-path }}

  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.57
    name: Generate run context (steps-pre)
    id: context-steps-pre
    with:
      input: ${{ inputs.steps-pre || '""' }}
      options: -Rs
      input-format: string
  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.57
    name: Generate run context (steps-post)
    id: context-steps-post
    with:
      input: ${{ inputs.steps-post || '""' }}
      options: -Rs
      input-format: string
  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.57
    name: Generate run context
    id: context
    with:
      input: ${{ toJSON(steps.run.outputs) }}
      filter: >-
        . * {"started": ${{ steps.started.outputs.timestamp }},
             "container-command": "${{ steps.command.outputs.container }}",
             "command": "${{ steps.command.outputs.actual }}",
             "completed": ${{ steps.completed.outputs.timestamp }},
             "steps-pre": ${{ steps.context-steps-pre.outputs.value }},
             "steps-post": ${{ steps.context-steps-post.outputs.value }},
             "exit-code": (.["exit-code"] | fromjson)}
        | {"run": .,
           "context": ${{ inputs.context }}}

  - uses: envoyproxy/toolshed/gh-actions/using/steps@actions-v0.1.57
    name: Run post steps
    if: ${{ inputs.steps-post }}
    with:
      name: ${{ inputs.steps-post-name }}
      steps: ${{ inputs.steps-post }}
      context: ${{ steps.context.outputs.value }}
  - uses: envoyproxy/toolshed/gh-actions/using/steps@actions-v0.1.57
    name: Post report
    if: ${{ inputs.report-post }}
    with:
      steps: ${{ inputs.report-post }}
      context: ${{ steps.context.outputs.value }}
  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.57
    id: post-failed
    if: ${{ failure() || cancelled() }}
    with:
      input: ${{ steps.context.outputs.value }}
      filter: |
        .run["post-steps-failed"] = true
  - uses: actions/upload-artifact@v3
    name: Upload artefacts
    if: ${{ inputs.upload-name && inputs.upload-path }}
    with:
      name: ${{ inputs.upload-name }}
      path: ${{ inputs.upload-path }}
  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.57
    id: upload-failed
    if: ${{ failure() || cancelled() }}
    with:
      input: ${{ steps.post-failed.outputs.value || steps.context.outputs.value }}
      filter: |
        .run["upload-failed"] = true
  - uses: envoyproxy/toolshed/gh-actions/using/steps@actions-v0.1.57
    name: Job summary
    if: ${{ always() && inputs.summary-post }}
    with:
      steps: ${{ inputs.summary-post }}
      context: ${{ steps.upload-failed.outputs.value || steps.post-failed.outputs.value || steps.context.outputs.value }}
  - run: |
      rm -rf "$TMP_STDOUT"
      rm -rf "$TMP_STDERR"
      if [[ "${EXIT_CODE}" -ne 0 ]]; then
          echo "Run failed" >&2
          exit ${EXIT_CODE}
      elif [[ "${#STEPS_POST_ERR}" -ne 0 ]]; then
          echo "Post steps failed" >&2
          echo "::error::Post steps failed" >&2
          exit 1
      elif [[ "${#UPLOAD_ERR}" -ne 0 ]]; then
          echo "Upload failed" >&2
          echo "::error::Upload failed" >&2
          exit 1
      fi
      exit ${EXIT_CODE}
    shell: bash
    if: ${{ always() }}
    env:
      EXIT_CODE: ${{ !fromJSON(inputs.catch-errors) && steps.run.outputs.exit-code || 0 }}
      STEPS_POST_ERR: ${{ toJSON(fromJSON(steps.post-failed.outputs.value || '{}').run) }}
      UPLOAD_ERR: ${{ toJSON(fromJSON(steps.upload-failed.outputs.value || '{}').run) }}
      TMP_STDERR: ${{ steps.run.outputs.stderr-path }}
      TMP_STDOUT: ${{ steps.run.outputs.stdout-path }}
