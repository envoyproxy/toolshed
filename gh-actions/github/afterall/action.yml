name: After all workflows check
description: Checks if all required workflows have completed successfully for a given commit SHA

inputs:
  jq-pre-filter:
    type: string
    default: >-
      {workflow_runs: [.workflow_runs[] | select(.name | IN(\($wf_names))) | {name, id, conclusion, created_at, status}]}
  max-pages:
    type: number
    default: 5
  per-page:
    type: number
    default: 200
  repo:
    type: string
    default: ${{ github.repository }}
  sha:
    type: string
    required: true
    description: Commit SHA to check
  workflows:
    type: string
    required: true
    description: JSON array of required workflow names
  token:
    type: string
    required: false
    default: ${{ github.token }}
    description: GitHub token
  template-script:
    type: string
    default: |
      export SCRIPT_JQ='\($jq)'
      export MAX_PAGES='\(.max_pages)'
      export HEAD_SHA='\(.sha)'
      export PER_PAGE='\(.per_page)'
      export REPO='\(.repo)'
      export OUTPUT=\"[]\"
      export WF_NAMES='\($wf_names)'
      OUTPUT=$(${AFTERALL_ACTION_PATH}/check-runs.sh)


outputs:
  status:
    value: ${{ steps.check-workflows.outputs.output }}
    description: Full status JSON object with details for each workflow
  continue:
    value: ${{ fromJSON(steps.check-workflows.outputs.output).continue }}
    description: "'true' or 'false' - whether all required workflows passed"
  run-ids:
    value: ${{ fromJSON(steps.check-workflows.outputs.output)['run-ids'] }}
    description: JSON object mapping workflow names to run IDs


runs:
  using: composite
  steps:
  - uses: envoyproxy/toolshed/gh-actions/jq@96eb7ac14988055e16064febfc4c035e6cff23ff
    id: workflows
    with:
      options: -sRc
      input: ${{ inputs.workflows }}
      filter: |
        .
        | split("\n")
        | map(select(length > 0))
  - uses: envoyproxy/toolshed/gh-actions/bson@96eb7ac14988055e16064febfc4c035e6cff23ff
    id: check-workflows
    env:
      GH_TOKEN: ${{ inputs.token }}
      AFTERALL_ACTION_PATH: ${{ github.action_path }}
    with:
      input: |
        max_pages: ${{ inputs.max-pages }}
        per_page: ${{ inputs.per-page }}
        repo: ${{ inputs.repo }}
        sha: ${{ inputs.sha }}
        workflows: ${{ steps.workflows.outputs.value }}
      input-format: yaml
      filter: |
        .
        | (.workflows | tojson | .[1:-1]) as $wf_names
        | "${{ inputs.jq-pre-filter }}" as $jq
        | ("${{ inputs.template-script }}" | bash::output)
      result-format: json
      result-filter-options: "-c"
      result-filter: |
        . as $data
        | ${{ steps.workflows.outputs.value }} as $workflows
        | .workflow_runs as $runs
        | {continue: true, "run-ids": {}, status: {}} as $init
        | reduce $workflows[] as $name ($init;
            ([$runs[] | select(.name == $name)] | sort_by(.created_at) | last) as $run
            | if $run then
                .status[$name] = {id: $run.id, status: $run.status, conclusion: $run.conclusion}
                | if $run.status == "completed" and $run.conclusion == "success" then
                    .["run-ids"][$name] = $run.id
                  else
                    .continue = false
                  end
              else
                .continue = false
              end)
        | {continue: (.continue | tostring),
           "run-ids": (."run-ids" | tojson),
           status: (.status | tojson)}
