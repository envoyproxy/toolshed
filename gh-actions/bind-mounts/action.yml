inputs:
  mounts:
    type: string
    required: true


# Example:
#
# - src: /mnt/foo
#   target: /some/other/path/foo
#   rm: false
#   permissions:
#   command-pre:
#   command-post:
# - src: /mnt/bar
#   target: /some/other/path/bar
#   rm: true
#   permissions: runner:runner
#   command-pre: sudo systemctl stop bar
#   command-post: sudo systemctl start bar

runs:
  using: composite
  steps:
  - name: Bind mount directories
    uses: envoyproxy/toolshed/gh-actions/bson@actions-v0.3.27
    id: mount
    with:
      input: ${{ inputs.mounts }}
      input-format: yaml
      filter: |
        .[]
        | (if ."command-pre" then ."command-pre" + "\n" else "" end),
          "sudo mkdir -p \(.src)",
          (if .permissions then "sudo chown \(.permissions) \(.src)" else "" end),
          (if .rm then "sudo rm -rf \(.target)" else "" end),
          "sudo mkdir -p \(.target)",
          "sudo mount -o bind \(.src) \(.target)",
          (if ."command-post" then ."command-post" + "\n" else "" end)
