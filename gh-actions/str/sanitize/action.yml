inputs:
  marker:
    type: string
    default: ☠☠☠
  replacements:
    type: string
    default: |
      - "%"
      - "\\$"
  seed:
    type: string
    default: ☠❂⚓
  string:
    type: string
    required: false

outputs:
  string:
    value: ${{ steps.string.outputs.value }}


runs:
  using: composite
  steps:
  - id: replacements
    uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.64
    with:
      input: ${{ inputs.replacements }}
      input-format: yaml
  - uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.1.64
    name: String
    id: string
    with:
      input: ${{ inputs.string }}
      options: -Rsr
      sanitize-input: false
      filter: >-
        . as $input
        | "${{ inputs.seed }}" as $seed
        | "${{ inputs.marker }}" as $marker
        | ${{ steps.replacements.outputs.value }} as $replacements
        | $replacements
        | reduce .[] as $replacement (
            "";
            (if (. == "") then $input else . end) as $string
            | select($replacement != "")
            | "\($marker)\($seed + $replacement + "{{" | @base64)\($marker)" as $placeholder
            | $string
            | gsub($replacement + "{{"; $placeholder))
