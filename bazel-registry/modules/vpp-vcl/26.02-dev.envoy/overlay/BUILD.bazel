load("@rules_cc//cc:defs.bzl", "cc_library")

# VPP Version - hardcoded because version detection requires git metadata or .version file
VPP_VERSION = "26.02-dev"

# Generate config.h for vppinfra
genrule(
    name = "config_h",
    outs = ["src/vppinfra/config.h"],
    cmd = """cat > $@ << 'EOF'
/* Generated by Bazel - VPP VCL config.h */
#ifndef _VPPINFRA_CONFIG_H
#define _VPPINFRA_CONFIG_H

#define CLIB_LOG2_CACHE_LINE_BYTES 6
#define CLIB_N_PREFETCHES 4
#define CLIB_LIB_DIR ""
#define CLIB_VECTOR_GROW_BY_ONE 0

#endif /* _VPPINFRA_CONFIG_H */
EOF
""",
)

# vppinfra - core infrastructure library
cc_library(
    name = "vppinfra",
    srcs = [
        "src/vppinfra/bitmap.c",
        "src/vppinfra/bihash_all_vector.c",
        "src/vppinfra/cpu.c",
        "src/vppinfra/devicetree.c",
        "src/vppinfra/dlmalloc.c",
        "src/vppinfra/elf.c",
        "src/vppinfra/elf_clib.c",
        "src/vppinfra/elog.c",
        "src/vppinfra/error.c",
        "src/vppinfra/fifo.c",
        "src/vppinfra/format.c",
        "src/vppinfra/format_table.c",
        "src/vppinfra/args.c",
        "src/vppinfra/hash.c",
        "src/vppinfra/heap.c",
        "src/vppinfra/interrupt.c",
        "src/vppinfra/longjmp.S",
        "src/vppinfra/macros.c",
        "src/vppinfra/maplog.c",
        "src/vppinfra/mem.c",
        "src/vppinfra/mem_bulk.c",
        "src/vppinfra/mem_dlmalloc.c",
        "src/vppinfra/mem_trace.c",
        "src/vppinfra/mhash.c",
        "src/vppinfra/mpcap.c",
        "src/vppinfra/pcap.c",
        "src/vppinfra/pmalloc.c",
        "src/vppinfra/pool.c",
        "src/vppinfra/ptclosure.c",
        "src/vppinfra/random_buffer.c",
        "src/vppinfra/random.c",
        "src/vppinfra/random_isaac.c",
        "src/vppinfra/rbtree.c",
        "src/vppinfra/serialize.c",
        "src/vppinfra/socket.c",
        "src/vppinfra/stack.c",
        "src/vppinfra/std-formats.c",
        "src/vppinfra/string.c",
        "src/vppinfra/time.c",
        "src/vppinfra/time_range.c",
        "src/vppinfra/timing_wheel.c",
        "src/vppinfra/tw_timer_16t_1w_2048sl.c",
        "src/vppinfra/tw_timer_16t_2w_512sl.c",
        "src/vppinfra/tw_timer_1t_3w_1024sl_ov.c",
        "src/vppinfra/tw_timer_2t_1w_2048sl.c",
        "src/vppinfra/tw_timer_2t_2w_512sl.c",
        "src/vppinfra/tw_timer_4t_3w_256sl.c",
        "src/vppinfra/tw_timer_4t_3w_4sl_ov.c",
        "src/vppinfra/unformat.c",
        "src/vppinfra/unix-formats.c",
        "src/vppinfra/unix-misc.c",
        "src/vppinfra/valloc.c",
        "src/vppinfra/vec.c",
        "src/vppinfra/vector.c",
        "src/vppinfra/vector/toeplitz.c",
        "src/vppinfra/cJSON.c",
        # Linux-specific sources
        "src/vppinfra/linux/mem.c",
        "src/vppinfra/linux/sysfs.c",
        "src/vppinfra/linux/netns.c",
        "src/vppinfra/perfmon/bundle_default.c",
        "src/vppinfra/perfmon/bundle_core_power.c",
        "src/vppinfra/perfmon/perfmon.c",
    ] + glob(["src/vppinfra/**/*.h"]),
    hdrs = glob(["src/vppinfra/**/*.h"]) + [":config_h"],
    copts = [
        "-fvisibility=hidden",
        "-DHAVE_LIBUNWIND=0",
        "-Wno-unused-variable",
        "-Wno-error=array-bounds",
    ],
    includes = ["src"],
    linkopts = [
        "-lm",
        "-ldl",
    ],
    local_defines = ["CJSON_API_VISIBILITY"],
    target_compatible_with = ["@platforms//os:linux"],
    visibility = ["//visibility:public"],
)

# svm - shared memory library
cc_library(
    name = "svm",
    srcs = [
        "src/svm/fifo_segment.c",
        "src/svm/message_queue.c",
        "src/svm/queue.c",
        "src/svm/svm.c",
        "src/svm/ssvm.c",
        "src/svm/svm_fifo.c",
    ],
    hdrs = glob(["src/svm/*.h"]),
    includes = ["src"],
    linkopts = [
        "-lrt",
        "-lpthread",
    ],
    target_compatible_with = ["@platforms//os:linux"],
    visibility = ["//visibility:public"],
    deps = [":vppinfra"],
)

# vppcom - VCL (VPP Communications Library) without BAPI
cc_library(
    name = "vppcom",
    srcs = [
        "src/vcl/vppcom.c",
        "src/vcl/vcl_cfg.c",
        "src/vcl/vcl_private.c",
        "src/vcl/vcl_locked.c",
        "src/vcl/vcl_sapi.c",
    ],
    hdrs = glob(["src/vcl/*.h"]),
    copts = [
        "-DHAVE_GNU_SOURCE",
    ],
    includes = ["src"],
    linkopts = [
        "-lrt",
        "-lpthread",
    ],
    target_compatible_with = ["@platforms//os:linux"],
    visibility = ["//visibility:public"],
    deps = [
        ":svm",
        ":vppinfra",
    ],
)

# Main public target alias
alias(
    name = "vpp-vcl",
    actual = ":vppcom",
    visibility = ["//visibility:public"],
)
