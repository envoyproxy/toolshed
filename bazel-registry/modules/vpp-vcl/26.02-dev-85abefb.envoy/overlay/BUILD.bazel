load("@rules_cc//cc:defs.bzl", "cc_library")

# Generate config.h for vppinfra
genrule(
    name = "vppinfra_config_h",
    outs = ["src/vppinfra/config.h"],
    cmd = """cat > $@ << 'EOF'
/* Generated by Bazel - VPP VCL config.h */
#ifndef _VPPINFRA_CONFIG_H
#define _VPPINFRA_CONFIG_H

#define CLIB_LOG2_CACHE_LINE_BYTES 6
#define CLIB_N_PREFETCHES 4
#define CLIB_LIB_DIR ""
#define CLIB_VECTOR_GROW_BY_ONE 0

#endif /* _VPPINFRA_CONFIG_H */
EOF
""",
)

# Generate vlib/config.h
genrule(
    name = "vlib_config_h",
    outs = ["src/vlib/config.h"],
    cmd = """cat > $@ << 'EOF'
/* Generated by Bazel - vlib config.h */
#ifndef __included_vlib_config_h__
#define __included_vlib_config_h__

#define VLIB_BUFFER_ALLOC_FAULT_INJECTOR 0
#define VLIB_BUFFER_ALIGN 64
#define VLIB_BUFFER_PRE_DATA_SIZE 128
#define VLIB_PROCESS_LOG2_STACK_SIZE 15

#endif /* __included_vlib_config_h__ */
EOF
""",
)

# Generate vpp/vnet/config.h
genrule(
    name = "vpp_vnet_config_h",
    outs = ["src/vpp/vnet/config.h"],
    cmd = """cat > $@ << 'EOF'
/* Generated by Bazel - vpp/vnet config.h */
#ifndef included_vpp_vnet_config_h
#define included_vpp_vnet_config_h

#define VPP_SANITIZE_ADDR_OPTIONS ""
#define VPP_IP_FIB_MTRIE_16 1
/* #undef VPP_TCP_DEBUG_ALWAYS */
/* #undef VPP_SESSION_DEBUG */
/* #undef VPP_VCL_ELOG */

#endif /* included_vpp_vnet_config_h */
EOF
""",
)

# Generate stub vlibmemory/api.h that provides minimal definitions
genrule(
    name = "vlibmemory_api_stub_h",
    outs = ["src/vlibmemory/api.h"],
    cmd = """cat > $@ << 'EOF'
/* Generated by Bazel - Stub vlibmemory/api.h for VCL SAPI-only mode */
#ifndef included_vlibmemory_api_h
#define included_vlibmemory_api_h

#include <vppinfra/clib.h>
#include <vppinfra/error.h>
#include <vppinfra/format.h>
#include <vppinfra/socket.h>
#include <svm/svm.h>
#include <svm/queue.h>
#include <svm/message_queue.h>
#include <svm/fifo_segment.h>

/* Minimal api_main_t stub for VCL SAPI-only mode */
typedef struct api_main_t_
{
  void *shmem_hdr;
  void *msg_data;
  u32 my_client_index;
  u32 my_registration;
} api_main_t;

/* Minimal memory_client_main_t stub */
typedef struct memory_client_main_t_
{
  void *shmem_hdr;
  u32 client_index;
} memory_client_main_t;

/* Minimal socket_client_main_t stub */
typedef struct socket_client_main_t_
{
  clib_socket_t client_socket;
  u32 socket_fd;
} socket_client_main_t;

static inline api_main_t *
vlibapi_get_main (void)
{
  static api_main_t am = {0};
  return &am;
}

#endif /* included_vlibmemory_api_h */
EOF
""",
)

# Generate vppcom.h at root include path for compatibility
genrule(
    name = "vppcom_root_h",
    outs = ["include/vppcom.h"],
    cmd = """cat > $@ << 'EOF'
/* Generated by Bazel - wrapper for vppcom.h */
#include <vcl/vppcom.h>
EOF
""",
)

# vppinfra - core infrastructure library
cc_library(
    name = "vppinfra",
    srcs = [
        "src/vppinfra/args.c",
        "src/vppinfra/bihash_all_vector.c",
        "src/vppinfra/bitmap.c",
        "src/vppinfra/cJSON.c",
        "src/vppinfra/cpu.c",
        "src/vppinfra/devicetree.c",
        "src/vppinfra/dlmalloc.c",
        "src/vppinfra/elf.c",
        "src/vppinfra/elf_clib.c",
        "src/vppinfra/elog.c",
        "src/vppinfra/error.c",
        "src/vppinfra/fifo.c",
        "src/vppinfra/format.c",
        "src/vppinfra/format_table.c",
        "src/vppinfra/hash.c",
        "src/vppinfra/heap.c",
        "src/vppinfra/interrupt.c",
        "src/vppinfra/linux/mem.c",
        "src/vppinfra/linux/netns.c",
        "src/vppinfra/linux/sysfs.c",
        "src/vppinfra/longjmp.S",
        "src/vppinfra/macros.c",
        "src/vppinfra/maplog.c",
        "src/vppinfra/mem.c",
        "src/vppinfra/mem_bulk.c",
        "src/vppinfra/mem_dlmalloc.c",
        "src/vppinfra/mem_trace.c",
        "src/vppinfra/mhash.c",
        "src/vppinfra/mpcap.c",
        "src/vppinfra/pcap.c",
        "src/vppinfra/perfmon/bundle_core_power.c",
        "src/vppinfra/perfmon/bundle_default.c",
        "src/vppinfra/perfmon/perfmon.c",
        "src/vppinfra/pmalloc.c",
        "src/vppinfra/pool.c",
        "src/vppinfra/ptclosure.c",
        "src/vppinfra/random.c",
        "src/vppinfra/random_buffer.c",
        "src/vppinfra/random_isaac.c",
        "src/vppinfra/rbtree.c",
        "src/vppinfra/serialize.c",
        "src/vppinfra/socket.c",
        "src/vppinfra/stack.c",
        "src/vppinfra/std-formats.c",
        "src/vppinfra/string.c",
        "src/vppinfra/time.c",
        "src/vppinfra/time_range.c",
        "src/vppinfra/timing_wheel.c",
        "src/vppinfra/tw_timer_16t_1w_2048sl.c",
        "src/vppinfra/tw_timer_16t_2w_512sl.c",
        "src/vppinfra/tw_timer_1t_3w_1024sl_ov.c",
        "src/vppinfra/tw_timer_2t_1w_2048sl.c",
        "src/vppinfra/tw_timer_2t_2w_512sl.c",
        "src/vppinfra/tw_timer_4t_3w_256sl.c",
        "src/vppinfra/tw_timer_4t_3w_4sl_ov.c",
        "src/vppinfra/unformat.c",
        "src/vppinfra/unix-formats.c",
        "src/vppinfra/unix-misc.c",
        "src/vppinfra/valloc.c",
        "src/vppinfra/vec.c",
        "src/vppinfra/vector.c",
        "src/vppinfra/vector/toeplitz.c",
    ],
    hdrs = glob(["src/vppinfra/**/*.h"]) + [":vppinfra_config_h"],
    textual_hdrs = [
        "src/vppinfra/tw_timer_template.c",
    ],
    copts = [
        "-fvisibility=hidden",
        "-DHAVE_LIBUNWIND=0",
        "-Wno-unused-variable",
        "-Wno-error=array-bounds",
    ],
    includes = ["src"],
    linkopts = [
        "-lm",
        "-ldl",
    ],
    local_defines = ["CJSON_API_VISIBILITY"],
    target_compatible_with = ["@platforms//os:linux"],
    visibility = ["//visibility:public"],
)

# svm - shared memory library
cc_library(
    name = "svm",
    srcs = [
        "src/svm/fifo_segment.c",
        "src/svm/message_queue.c",
        "src/svm/queue.c",
        "src/svm/ssvm.c",
        "src/svm/svm.c",
        "src/svm/svm_fifo.c",
    ],
    hdrs = glob(["src/svm/*.h"]),
    includes = ["src"],
    linkopts = [
        "-lpthread",
        "-lrt",
    ],
    target_compatible_with = ["@platforms//os:linux"],
    visibility = ["//visibility:public"],
    deps = [":vppinfra"],
)

# Headers-only library for vnet/vlib/vpp types used by VCL
cc_library(
    name = "vnet_session_hdrs",
    hdrs = glob([
        "src/vnet/**/*.h",
        "src/vnet/**/*.def",
        "src/vlib/**/*.h",
        "src/vlib/**/*.def",
        "src/vpp/**/*.h",
    ]) + [
        ":vlib_config_h",
        ":vpp_vnet_config_h",
        ":vlibmemory_api_stub_h",
    ],
    includes = ["src"],
    target_compatible_with = ["@platforms//os:linux"],
    visibility = ["//visibility:private"],
    deps = [
        ":svm",
        ":vppinfra",
    ],
)

# vppcom - VCL (VPP Communications Library) SAPI-only mode
cc_library(
    name = "vppcom",
    srcs = [
        "src/vcl/vcl_cfg.c",
        "src/vcl/vcl_locked.c",
        "src/vcl/vcl_private.c",
        "src/vcl/vcl_sapi.c",
        "src/vcl/vppcom.c",
    ],
    hdrs = glob(["src/vcl/*.h"]) + [":vppcom_root_h"],
    copts = [
        "-D_GNU_SOURCE",
        "-Wno-unused-variable",
        "-Wno-error=array-bounds",
    ],
    includes = [
        "include",
        "src",
    ],
    linkopts = [
        "-lpthread",
        "-lrt",
    ],
    target_compatible_with = ["@platforms//os:linux"],
    visibility = ["//visibility:public"],
    deps = [
        ":svm",
        ":vnet_session_hdrs",
        ":vppinfra",
    ],
)

# Main public target alias
alias(
    name = "vpp-vcl",
    actual = ":vppcom",
    visibility = ["//visibility:public"],
)
