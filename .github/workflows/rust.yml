name: Rust

on:
  push:
    branches:
    - main
    paths:
    - rust/**
    - .github/workflows/rust.yml
  pull_request:
    branches:
    - main
    paths:
    - rust/**
    - .github/workflows/rust.yml
  release:
    types:
      released

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-24.04
    if: github.repository_owner == 'envoyproxy'
    strategy:
      fail-fast: false
      matrix:
        toolchain:
        - stable
        - nightly
        test-type:
        - coverage
        - integration
    name: test (${{ matrix.toolchain }}, ${{ matrix.test-type }})
    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
    - uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c  # v1
      with:
        toolchain: ${{ matrix.toolchain }}
    - name: Install cargo-tarpaulin
      if: matrix.test-type == 'coverage'
      run: cargo install cargo-tarpaulin
    - name: Run coverage
      if: matrix.test-type == 'coverage'
      run: |
        cargo tarpaulin --config tarpaulin.toml --features test --lib --bins
      working-directory: rust
    - name: Run glint integration tests
      if: matrix.test-type == 'integration'
      run: |
        cargo test --package glint --test integration_test --verbose
      working-directory: rust

  build:
    if: github.event_name == 'release' && startsWith(github.event.release.name, 'bazel-bins')
    runs-on: ${{ matrix.runs-on }}
    strategy:
      matrix:
        include:
        - arch: amd64
          runs-on: ubuntu-24.04
          rust-target: x86_64-unknown-linux-gnu
        - arch: arm64
          runs-on: ubuntu-24.04-arm
          rust-target: aarch64-unknown-linux-gnu
    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c  # v1
      with:
        toolchain: stable

    - name: Build glint
      run: cargo build --release -p glint
      working-directory: rust

    - name: Get glint version
      id: version
      run: |
        cd rust/glint
        VERSION=$(cargo metadata --no-deps --format-version=1 | jq -r '.packages[0].version')
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Strip binary
      run: strip rust/target/release/glint

    - name: Rename binary with version and architecture
      run: |
        cp rust/target/release/glint glint-${{ steps.version.outputs.version }}-${{ matrix.arch }}

    - name: Upload glint binary
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
      with:
        name: glint-${{ steps.version.outputs.version }}-${{ matrix.arch }}
        path: glint-${{ steps.version.outputs.version }}-${{ matrix.arch }}
        retention-days: 30

  publish:
    if: github.event_name == 'release' && startsWith(github.event.release.name, 'bazel-bins')
    runs-on: ubuntu-24.04
    needs:
    - build
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
    - name: Download all workflow run artifacts
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
      with:
        path: artifacts
    - name: Upload release assets
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        for artifact in artifacts/*; do
            [[ ! -d "$artifact" ]] && continue
            name=$(basename "$artifact")
            file=$(ls "$artifact"/glint-*)
            echo "Uploading $file as $name"
            gh release upload "${{ github.event.release.tag_name }}" \
                "$file#$name" \
                --clobber
        done

  status:
    runs-on: ubuntu-24.04
    if: always()
    name: Rust
    needs:
    - test
    steps:
    - run: |
        if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" || "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more jobs failed or were cancelled"
            exit 1
        fi
        echo "All required jobs passed or were skipped"
