name: Test Publish Workflow

permissions:
  actions: read

on:
  pull_request:
    paths:
    - .github/workflows/_publish.yml
    - .github/workflows/test-publish.yml

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true


jobs:
  get-main-sha:
    runs-on: ubuntu-24.04
    outputs:
      sha: ${{ steps.get-sha.outputs.sha }}
    steps:
    - name: Get latest SHA from main
      id: get-sha
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        SHA=$(gh api /repos/${{ github.repository }}/git/ref/heads/main --jq '.object.sha')
        echo "sha=$SHA" >> $GITHUB_OUTPUT
        echo "Latest SHA from main: $SHA"

  test-publish:
    needs: get-main-sha
    permissions:
      actions: read
    uses: ./.github/workflows/_publish.yml
    with:
      conclusion: success
      sha: ${{ needs.get-main-sha.outputs.sha }}
      workflows: |
        Bazel CI
        Rust CI
