name: Update Bazel Versions

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: Release tag to update from (e.g., bazel-bins/v0.1.7)
        required: false
        type: string
  push:
    branches:
    - main
    paths:
    - bazel/versions.bzl
    - .github/workflows/update-versions.yml
  pull_request:
    paths:
    - bazel/versions.bzl
    - .github/workflows/update-versions.yml

permissions:
  contents: read


jobs:
  update-versions:
    permissions:
      contents: write
      pull-requests: write
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
    - name: Determine release tag
      id: release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.release_tag }}" ]]; then
            TAG="${{ github.event.inputs.release_tag }}"
        else
            TAG=$(gh release list --limit 100 | grep "bazel-bins-v" | head -1 | awk '{print $1}' || true)
            echo "TAG: $TAG"
            if [[ -z "$TAG" ]]; then
                echo "No bazel-bins release found - skipping version check"
                echo "skip=true" >> $GITHUB_OUTPUT
                exit 0
            fi
        fi
        echo "skip=false" >> $GITHUB_OUTPUT
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        VERSION=$(echo "${TAG}" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
    - name: Download release assets
      if: steps.release.outputs.skip != 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        mkdir -p artifacts
        gh release view "${{ steps.release.outputs.tag }}" --json assets -q '.assets[].name' | while read -r asset; do
            echo "Downloading ${asset}..."
            gh release download "${{ steps.release.outputs.tag }}" --pattern "${asset}" --dir artifacts
        done
        echo "Downloaded artifacts:"
        ls -la artifacts/
    - name: Calculate SHA256 hashes
      if: steps.release.outputs.skip != 'true'
      id: hashes
      run: |
        cd artifacts
        
        # Calculate hashes for all files
        echo "## Calculating SHA256 hashes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Sanitizer libraries
        for sanitizer in msan tsan; do
            file=$(ls ${sanitizer}-llvm*-x86_64.tar.xz 2>/dev/null || true)
            if [[ -n "$file" && -e "$file" ]]; then
                hash=$(sha256sum "$file" | cut -d' ' -f1)
                echo "${sanitizer}_libs_sha256=${hash}" >> $GITHUB_OUTPUT
                echo "- ${file}: \`${hash}\`" >> $GITHUB_STEP_SUMMARY
            else
                echo "⚠️ Warning: ${sanitizer} libs not found" >> $GITHUB_STEP_SUMMARY
            fi
        done
        
        # Sysroot archives - nested structure for versions.bzl
        # Format: sysroot_hashes[glibc_version][stdlib_variant][arch]
        for glibc in "2.31" "2.28"; do
            for variant in "base" "13"; do
                for arch in "amd64" "arm64"; do
                    if [[ "$variant" == "base" ]]; then
                        file=$(ls sysroot-glibc${glibc}-${arch}.tar.xz 2>/dev/null || true)
                    else
                        file=$(ls sysroot-glibc${glibc}-libstdc++${variant}-${arch}.tar.xz 2>/dev/null || true)
                    fi
                    
                    if [[ -n "$file" && -e "$file" ]]; then
                        hash=$(sha256sum "$file" | cut -d' ' -f1)
                        # Output in format that can be parsed later
                        echo "sysroot_${glibc}_${variant}_${arch}=${hash}" >> $GITHUB_OUTPUT
                        echo "- ${file}: \`${hash}\`" >> $GITHUB_STEP_SUMMARY
                    else
                        echo "⚠️ Warning: sysroot glibc${glibc} ${variant} ${arch} not found" >> $GITHUB_STEP_SUMMARY
                    fi
                done
            done
        done
        
        # Legacy sysroot hashes (for backward compatibility with glibc 2.31 + libstdc++13)
        file=$(ls sysroot-glibc2.31-libstdc++13-amd64.tar.xz 2>/dev/null || true)
        if [[ -n "$file" && -e "$file" ]]; then
            hash=$(sha256sum "$file" | cut -d' ' -f1)
            echo "sysroot_amd64_sha256=${hash}" >> $GITHUB_OUTPUT
        fi
        
        file=$(ls sysroot-glibc2.31-libstdc++13-arm64.tar.xz 2>/dev/null || true)
        if [[ -n "$file" && -e "$file" ]]; then
            hash=$(sha256sum "$file" | cut -d' ' -f1)
            echo "sysroot_arm64_sha256=${hash}" >> $GITHUB_OUTPUT
        fi
        
        # Glint binaries
        for arch in "amd64" "arm64"; do
            file=$(ls glint-*-${arch} 2>/dev/null || true)
            if [[ -n "$file" && -e "$file" ]]; then
                hash=$(sha256sum "$file" | cut -d' ' -f1)
                echo "glint_${arch}_sha256=${hash}" >> $GITHUB_OUTPUT
                echo "- ${file}: \`${hash}\`" >> $GITHUB_STEP_SUMMARY
            else
                echo "⚠️ Warning: glint ${arch} binary not found" >> $GITHUB_STEP_SUMMARY
            fi
        done
    - name: Update versions.bzl
      if: steps.release.outputs.skip != 'true'
      env:
        VERSION: ${{ steps.release.outputs.version }}
        MSAN_LIBS_SHA256: ${{ steps.hashes.outputs.msan_libs_sha256 }}
        TSAN_LIBS_SHA256: ${{ steps.hashes.outputs.tsan_libs_sha256 }}
        GLINT_AMD64_SHA256: ${{ steps.hashes.outputs.glint_amd64_sha256 }}
        GLINT_ARM64_SHA256: ${{ steps.hashes.outputs.glint_arm64_sha256 }}
        SYSROOT_2_31_BASE_AMD64: ${{ steps.hashes.outputs.sysroot_2_31_base_amd64 }}
        SYSROOT_2_31_BASE_ARM64: ${{ steps.hashes.outputs.sysroot_2_31_base_arm64 }}
        SYSROOT_2_31_13_AMD64: ${{ steps.hashes.outputs.sysroot_2_31_13_amd64 }}
        SYSROOT_2_31_13_ARM64: ${{ steps.hashes.outputs.sysroot_2_31_13_arm64 }}
        SYSROOT_2_28_BASE_AMD64: ${{ steps.hashes.outputs.sysroot_2_28_base_amd64 }}
        SYSROOT_2_28_BASE_ARM64: ${{ steps.hashes.outputs.sysroot_2_28_base_arm64 }}
        SYSROOT_2_28_13_AMD64: ${{ steps.hashes.outputs.sysroot_2_28_13_amd64 }}
        SYSROOT_2_28_13_ARM64: ${{ steps.hashes.outputs.sysroot_2_28_13_arm64 }}
        SYSROOT_AMD64_SHA256: ${{ steps.hashes.outputs.sysroot_amd64_sha256 }}
        SYSROOT_ARM64_SHA256: ${{ steps.hashes.outputs.sysroot_arm64_sha256 }}
      run: |
        python3 .github/scripts/update_hashes.py
        
        echo "## Updated versions.bzl" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`diff" >> $GITHUB_STEP_SUMMARY
        git diff bazel/versions.bzl >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        echo "Updated versions.bzl:"
        git diff bazel/versions.bzl
    - name: Check for changes
      if: steps.release.outputs.skip != 'true'
      id: changes
      run: |
        if git diff --quiet bazel/versions.bzl; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to versions.bzl"
        else
            echo "changed=true" >> $GITHUB_OUTPUT
        fi
    - name: Create Pull Request
      if: github.event_name == 'workflow_dispatch' && steps.changes.outputs.changed == 'true' && steps.release.outputs.skip != 'true'
      uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725  # v8
      env:
        MSAN_SHA: >-
          ${{ steps.hashes.outputs.msan_libs_sha256
              && format('msan_libs_sha256: {0}', steps.hashes.outputs.msan_libs_sha256)
              || '' }}
        SYSROOT_ARM64_SHA: >-
          ${{ steps.hashes.outputs.sysroot_arm64_sha256
              && format('sysroot_arm64_sha256: {0}', steps.hashes.outputs.sysroot_arm64_sha256)
              || '' }}
        SYSROOT_X64_SHA: >-
          ${{ steps.hashes.outputs.sysroot_amd64_sha256
              && format('sysroot_amd64_sha256: {0}', steps.hashes.outputs.sysroot_amd64_sha256)
              || '' }}
        TSAN_SHA: >-
          ${{ steps.hashes.outputs.tsan_libs_sha256
              && format('tsan_libs_sha256: {0}', steps.hashes.outputs.tsan_libs_sha256)
              || '' }}
      with:
        token: ${{ github.token }}
        commit-message: "Update bazel-bins to ${{ steps.release.outputs.version }}"
        branch: "update-bazel-bins-${{ steps.release.outputs.version }}"
        delete-branch: true
        title: "Update bazel-bins to ${{ steps.release.outputs.version }}"
        body: |
          This PR updates the bazel-bins version and SHA256 hashes for release `${{ steps.release.outputs.tag }}`.

          ## Changes
          - Updated `bins_release` version to `${{ steps.release.outputs.version }}`
          - Updated SHA256 hashes for all binary artifacts

          ## Release Assets
          The following artifacts were processed:
          ```
          $MSAN_SHA
          $TSAN_SHA
          $SYSROOT_ARM64_SHA
          $SYSROOT_X64_SHA
          ```

          This PR was automatically generated by the Update Bazel Versions workflow.
        labels: |
          automation
          dependencies
    - name: Summary
      if: github.event_name != 'workflow_dispatch' && steps.changes.outputs.changed == 'true' && steps.release.outputs.skip != 'true'
      run: |
        echo "## Versions Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Latest bazel-bins release: ${{ steps.release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
        echo "Version: ${{ steps.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Changes detected:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`diff" >> $GITHUB_STEP_SUMMARY
        git diff bazel/versions.bzl >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
