name: _bazel

on:
  workflow_call:
    inputs:
      action:
        description: Bazel action (build or test)
        required: true
        type: string
      artifacts:
        description: Artifacts to upload
        required: false
        type: string
      bazel-args:
        description: Bazel args
        default:
        type: string
      bazel-mode:
        description: Bazel mode (workspace or bzlmod)
        required: true
        type: string
      bazel-path:
        description: Path to bazel workspace
        default: .
        type: string
      targets:
        description: Bazel targets
        required: true
        type: string
      upload:
        description: Upload CI artifacts
        type: boolean
        default: false


permissions:
  contents: read

jobs:
  bazel:
    runs-on: ubuntu-24.04
    name: Bazel (${{ inputs.action }})
    steps:
    - name: Checkout Repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
    - name: Setup Bazel
      uses: bazelbuild/setup-bazelisk@b39c379c82683a5f25d34f0d062761f62693e0b2  # v3
    - name: Install libtinfo5
      run: |
        # Workaround for https://github.com/llvm/llvm-project/issues/75490
        curl -LO "http://archive.ubuntu.com/ubuntu/pool/universe/n/ncurses/libtinfo5_6.3-2ubuntu0.1_amd64.deb"
        sudo dpkg -i "libtinfo5_6.3-2ubuntu0.1_amd64.deb"
        rm "libtinfo5_6.3-2ubuntu0.1_amd64.deb"
        sudo apt-get -qq update
        sudo apt-get -qq install -y --no-install-recommends debootstrap qemu-user-static binfmt-support

    - name: Bazel targets (${{ inputs.action }}/${{ inputs.bazel-mode }})
      run: |
        exec bazel ${{ inputs.action }} ${{ inputs.bazel-args }} ${{ inputs.targets }}
      working-directory: ${{ inputs.bazel-path }}
    - name: Bazel artifact paths
      id: artifact-paths
      if: >-
        inputs.action == 'build'
        && inputs.artifacts
        && inputs.upload
      uses: envoyproxy/toolshed/gh-actions/jq@096010c6d6fa0dda46956ceab0054d50ebb81c28
      with:
        input: ${{ inputs.artifacts }}
        input-format: text
        options: -Rr
        filter: |
          select(length > 0)
          | "${{ inputs.bazel-path }}/bazel-bin/\(.)"
    - name: Bazel artifacts
      if: ${{ steps.artifact-paths.outputs.value }}
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
      with:
        name: bazel-artifacts
        path: |
          ${{ steps.artifact-paths.outputs.value }}
        retention-days: 30
