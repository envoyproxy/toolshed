name: Rebuild Dependabot dist files

on:
  workflow_run:
    workflows:
    - JavaScript CI
    types:
    - completed

permissions:
  actions: read
  contents: write

jobs:
  rebuild-dist:
    # Only run if the workflow was triggered by a pull_request event from dependabot
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.actor.login == 'dependabot[bot]'

    runs-on: ubuntu-24.04

    steps:
    - name: Get PR branch
      id: pr-branch
      uses: actions/github-script@v7
      with:
        script: |
          const pr = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.workflow_run.pull_requests[0].number
          });
          core.setOutput('branch', pr.data.head.ref);
          core.setOutput('pr_number', pr.data.number);

    - name: Setup appauth
      id: appauth
      uses: envoyproxy/toolshed/actions/appauth@c73c1b842058331a14008432c0e162b97cccb2f5
      with:
        app_id: ${{ secrets.ENVOY_CI_PUBLISH_APP_ID }}
        key: ${{ secrets.ENVOY_CI_PUBLISH_APP_KEY }}

    - name: Checkout PR branch
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
      with:
        ref: ${{ steps.pr-branch.outputs.branch }}
        token: ${{ steps.appauth.outputs.token }}

    - name: Setup Node.js
      uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6.1.0
      with:
        node-version: 20.x

    - name: Rebuild all JS packages
      run: |
        # Find all package.json files in js directory
        packages="js/appauth js/dispatch js/github/checks js/github/mutex"
        packages="$packages js/github/script/run js/hashfiles js/jq js/retest js/torun"
        for pkg_dir in $packages; do
          if [ -d "$pkg_dir" ] && [ -f "$pkg_dir/package.json" ]; then
            echo "Processing $pkg_dir"
            cd "$pkg_dir"
            npm ci
            npm run build
            cd - > /dev/null
          fi
        done

    - name: Commit and push if changes detected
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"

        if [[ $(git status --porcelain) ]]; then
          echo "Changes detected in dist files after rebuild"
          git add js/**/dist/
          git commit -m "chore: rebuild dist files for dependabot PR #${{ steps.pr-branch.outputs.pr_number }}"
          git push origin ${{ steps.pr-branch.outputs.branch }}
          echo "Changes committed and pushed successfully"
        else
          echo "No changes detected in dist files"
        fi
