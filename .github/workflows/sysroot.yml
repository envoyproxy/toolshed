name: Build Sysroots

on:
  push:
    branches:
    - main
  pull_request:
  release:
    types:
    - published

permissions:
  contents: read

jobs:
  should:
    runs-on: ubuntu-24.04
    if: github.event_name != 'release'
    outputs:
      run: ${{ steps.filter.outputs.run }}
    steps:
    - uses: envoyproxy/toolshed/gh-actions/github/should-run@bccac0f1695cc07c67c46d5f494db6cef3e0a94e
      id: filter
      with:
        config: |
          paths:
          - 'bazel/sysroot/**'
          - '.github/workflows/sysroot.yml'

  build:
    runs-on: ${{ matrix.runs-on }}
    needs: should
    if: >-
      always()
      && (github.event_name == 'release'
      || fromJSON(needs.should.outputs.run || 'false'))
    strategy:
      fail-fast: false
      matrix:
        include:
        # glibc 2.31 (current) - Debian bullseye
        - arch: amd64
          runs-on: ubuntu-24.04
          variant: base
          glibc-version: "2.31"
          debian-version: bullseye
          ppa-toolchain: focal
        - arch: arm64
          runs-on: ubuntu-24.04-arm
          variant: base
          glibc-version: "2.31"
          debian-version: bullseye
          ppa-toolchain: focal
        - arch: amd64
          runs-on: ubuntu-24.04
          variant: libstdcxx
          glibc-version: "2.31"
          debian-version: bullseye
          ppa-toolchain: focal
        - arch: arm64
          runs-on: ubuntu-24.04-arm
          variant: libstdcxx
          glibc-version: "2.31"
          debian-version: bullseye
          ppa-toolchain: focal
        # glibc 2.28 (older) - Debian buster for Ubuntu 18.04/RHEL 8 compatibility
        - arch: amd64
          runs-on: ubuntu-24.04
          variant: base
          glibc-version: "2.28"
          debian-version: buster
          ppa-toolchain: bionic
        - arch: arm64
          runs-on: ubuntu-24.04-arm
          variant: base
          glibc-version: "2.28"
          debian-version: buster
          ppa-toolchain: bionic
        - arch: amd64
          runs-on: ubuntu-24.04
          variant: libstdcxx
          glibc-version: "2.28"
          debian-version: buster
          ppa-toolchain: bionic
        - arch: arm64
          runs-on: ubuntu-24.04-arm
          variant: libstdcxx
          glibc-version: "2.28"
          debian-version: buster
          ppa-toolchain: bionic
    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
    - name: Set versions
      id: versions
      run: |
        echo "ppa-toolchain=${{ matrix.ppa-toolchain }}" >> $GITHUB_OUTPUT
        echo "debian=${{ matrix.debian-version }}" >> $GITHUB_OUTPUT
        echo "stdcc=${STDCC_VERSION}" >> $GITHUB_OUTPUT
        echo "glibc=${{ matrix.glibc-version }}" >> $GITHUB_OUTPUT
      env:
        STDCC_VERSION: 13

    - name: Install debootstrap
      run: |
        sudo apt-get -qq update
        sudo apt-get -qq install -y debootstrap
    - name: Build ${{ matrix.arch }} ${{ matrix.variant }} sysroot
      run: |
        # Use archive.debian.org for archived releases (buster), deb.debian.org for current releases
        if [[ "${{ steps.versions.outputs.debian }}" == "buster" ]]; then
            DEBIAN_MIRROR="http://archive.debian.org/debian/"
            # buster uses libgcc1 (old package name)
            LIBGCC_PACKAGE="libgcc1"
        else
            DEBIAN_MIRROR="http://deb.debian.org/debian/"
            # bullseye and newer use libgcc-s1
            LIBGCC_PACKAGE="libgcc-s1"
        fi
        sudo debootstrap \
          --arch=${{ matrix.arch }} \
          --variant=minbase \
          ${{ steps.versions.outputs.debian }} \
          sysroot-${{ matrix.arch }} \
          $DEBIAN_MIRROR
        echo "deb [check-valid-until=no] http://archive.debian.org/debian ${{ steps.versions.outputs.debian }}-backports main" \
          | sudo tee sysroot-${{ matrix.arch }}/etc/apt/sources.list.d/backports.list
        sudo chroot sysroot-${{ matrix.arch }} apt-get -qq update
        sudo chroot sysroot-${{ matrix.arch }} apt-get -qq install --no-install-recommends -y \
          libc6 libc6-dev $LIBGCC_PACKAGE libxml2-dev
        sudo chroot sysroot-${{ matrix.arch }} apt-get -qq install --no-install-recommends -y \
          -t ${{ steps.versions.outputs.debian }}-backports linux-libc-dev
        if [[ "${{ matrix.variant }}" == "libstdcxx" ]]; then
            echo "deb http://ppa.launchpad.net/ubuntu-toolchain-r/test/ubuntu ${{ steps.versions.outputs.ppa-toolchain }} main" \
              | sudo tee sysroot-${{ matrix.arch }}/etc/apt/sources.list.d/toolchain.list
            sudo apt-key --keyring sysroot-${{ matrix.arch }}/etc/apt/trusted.gpg adv \
              --keyserver keyserver.ubuntu.com --recv-keys 1E9377A2BA9EF27F
            sudo chroot sysroot-${{ matrix.arch }} apt-get -qq update
            sudo chroot sysroot-${{ matrix.arch }} apt-get -qq install -y libstdc++-${{ steps.versions.outputs.stdcc }}-dev
        fi
    - name: Cleanup sysroot
      run: |
        sudo chroot sysroot-${{ matrix.arch }} apt-get clean
        sudo rm -rf "sysroot-${{ matrix.arch }}/boot"
        sudo rm -rf "sysroot-${{ matrix.arch }}/bin"
        sudo rm -rf "sysroot-${{ matrix.arch }}/dev"
        sudo rm -rf "sysroot-${{ matrix.arch }}/etc/alternatives"
        sudo rm -rf "sysroot-${{ matrix.arch }}/etc/rmt"
        sudo rm -rf "sysroot-${{ matrix.arch }}/etc/systemd"
        sudo rm -rf "sysroot-${{ matrix.arch }}/etc/localtime"
        sudo rm -rf "sysroot-${{ matrix.arch }}/home"
        sudo rm -rf "sysroot-${{ matrix.arch }}/media"
        sudo rm -rf "sysroot-${{ matrix.arch }}/opt"
        sudo rm -rf "sysroot-${{ matrix.arch }}/proc"
        sudo rm -rf "sysroot-${{ matrix.arch }}/root"
        sudo rm -rf "sysroot-${{ matrix.arch }}/run"
        sudo rm -rf "sysroot-${{ matrix.arch }}/sbin"
        sudo rm -rf "sysroot-${{ matrix.arch }}/srv"
        sudo rm -rf "sysroot-${{ matrix.arch }}/sys"
        sudo rm -rf "sysroot-${{ matrix.arch }}/tmp"
        sudo rm -rf "sysroot-${{ matrix.arch }}/usr/bin/awk"
        sudo rm -rf "sysroot-${{ matrix.arch }}/usr/bin/nawk"
        sudo rm -rf "sysroot-${{ matrix.arch }}/usr/bin/pager"
        sudo rm -rf "sysroot-${{ matrix.arch }}/usr/bin/pidof"
        sudo rm -rf "sysroot-${{ matrix.arch }}/usr/sbin"
        sudo rm -rf "sysroot-${{ matrix.arch }}/usr/share/doc"
        sudo rm -rf "sysroot-${{ matrix.arch }}/usr/share/info"
        sudo rm -rf "sysroot-${{ matrix.arch }}/usr/share/lintian"
        sudo rm -rf "sysroot-${{ matrix.arch }}/usr/share/man"
        sudo rm -rf "sysroot-${{ matrix.arch }}/usr/share/zoneinfo"
        sudo rm -rf "sysroot-${{ matrix.arch }}/var"

        sudo rm -rf sysroot-${{ matrix.arch }}/etc/apt/sources.list.d/*

        root_dir="sysroot-${{ matrix.arch }}"
        find "$root_dir" -type l | while read symlink; do
            # Get the current target
            current_target=$(readlink "$symlink")

            # Skip if already relative
            if [[ "$current_target" != /* ]]; then
                continue
            fi

            # If target exists within our sysroot, make it relative
            if [[ -e "$root_dir$current_target" ]]; then
                link_dir=$(dirname "$symlink")
                relative_path=$(realpath --relative-to="$link_dir" "$root_dir$current_target")
                sudo ln -sf "$relative_path" "$symlink"

                echo "Fixed: $symlink -> $relative_path (was: $current_target)"
            else
                echo "Skipping - target outside sysroot: $symlink -> $current_target"
            fi
        done

    - name: Package sysroot
      run: |
        if [[ "${{ matrix.variant }}" == "libstdcxx" ]]; then
            sudo tar -cJf \
                sysroot-glibc${{ steps.versions.outputs.glibc }}-libstdc++${{ steps.versions.outputs.stdcc }}-${{ matrix.arch }}.tar.xz \
                -C sysroot-${{ matrix.arch }} \
                .
        else
            sudo tar -cJf \
                sysroot-glibc${{ steps.versions.outputs.glibc }}-${{ matrix.arch }}.tar.xz \
                -C sysroot-${{ matrix.arch }} \
                .
        fi
    - name: Upload ${{ matrix.arch }} ${{ matrix.variant }} sysroot
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
      with:
        name: >-
          sysroot-glibc${{
              steps.versions.outputs.glibc
          }}${{
              matrix.variant == 'libstdcxx' && format('-libstdc++{0}', steps.versions.outputs.stdcc) || ''
          }}-${{ matrix.arch }}
        path: >-
          sysroot-glibc${{
              steps.versions.outputs.glibc
          }}${{
              matrix.variant == 'libstdcxx' && format('-libstdc++{0}', steps.versions.outputs.stdcc) || ''
          }}-${{ matrix.arch }}.tar.xz
        retention-days: 30

  publish:
    if: >-
      github.event_name == 'release'
      && startsWith(github.event.release.name, 'bazel-bins')
    runs-on: ubuntu-24.04
    needs:
    - build
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
    - name: Download all workflow run artifacts
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
      with:
        path: artifacts
    - name: Upload release assets
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        for artifact in artifacts/*; do
            [[ ! -d "$artifact" ]] && continue
            name=$(basename "$artifact")
            file=$(ls "$artifact"/*.tar.xz)
            echo "Uploading $file as $name.tar.xz"
            gh release upload "${{ github.event.release.tag_name }}" \
                "$file#$name.tar.xz" \
                --clobber
        done

  status:
    runs-on: ubuntu-24.04
    if: >-
      always()
      && github.event_name == 'pull_request'
    name: Sysroot
    needs:
    - should
    - build
    steps:
    - run: |
        if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" || "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more jobs failed or were cancelled"
            exit 1
        fi
        echo "All required jobs passed or were skipped"
