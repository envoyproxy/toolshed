name: _publish

permissions:
  actions: read

on:
  workflow_call:
    inputs:
      conclusion:
        default: ${{ github.event.workflow_run.conclusion }}
        type: string
      repository:
        default: envoyproxy/toolshed
        # default: ${{ github.repository }}
        type: string
      sha:
        default: ${{ github.event.workflow_run.head_sha }}
        type: string
      workflows:
        type: string
        required: true


jobs:
  check-and-publish:
    permissions:
      actions: read
    if: ${{ inputs.conclusion == 'success' }}
    runs-on: ubuntu-24.04
    steps:
    - name: Check all workflows ran
      id: afterall
      uses: envoyproxy/toolshed/gh-actions/github/afterall@43c4cefb2f73323d5621c661f7afc4d8a85ea3ac
      with:
        sha: ${{ inputs.sha }}
        workflows: ${{ inputs.workflows }}
        repo: envoyproxy/toolshed

    - name: Find associated PR
      id: find-pr
      uses: envoyproxy/toolshed/gh-actions/bson@actions-v0.3.35
      env:
        GH_TOKEN: ${{ github.token }}
      with:
        catch-errors: true
        input: |
          repo: ${{ github.repository }}
          sha: ${{ inputs.sha }}
        input-format: yaml
        filter: |
          .repo as $repo
          | .sha as $sha
          | ("gh api --jq '[.[] | {number, created_at, title}] | sort_by(.created_at) | last' "
             + "\"/repos/\($repo)/commits/\($sha)/pulls\"") as $cmd
          | "OUTPUT=$(\($cmd))"
          | bash::output
        result-filter: |
          if . != "" and . != "null" then . else "{}" end
    - name: Get commit info
      id: commit-info
      uses: envoyproxy/toolshed/gh-actions/bson@actions-v0.3.35
      env:
        GH_TOKEN: ${{ github.token }}
      with:
        catch-errors: true
        input: |
          repo: ${{ github.repository }}
          sha: ${{ inputs.sha }}
        input-format: yaml
        filter: |
          .repo as $repo
          | .sha as $sha
          | "OUTPUT=$(gh api --jq '{message: .commit.message}' \"/repos/\($repo)/commits/\($sha)\")"
          | bash::output
        result-filter: |
          if . != "" and . != "null" then . else "{}" end
    - name: Download Artifacts (Bazel CI)
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ github.token }}
        run-id: ${{ fromJSON(steps.afterall.outputs.run-ids)['Bazel CI'] }}
        path: ./artifacts/bazel
        repository: ${{ inputs.repository }}
    - name: Download Artifacts (Rust CI)
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ github.token }}
        run-id: ${{ fromJSON(steps.afterall.outputs.run-ids)['Rust CI'] }}
        path: ./artifacts/rust
        repository: ${{ inputs.repository }}
    - name: List downloaded artifacts
      id: artifacts
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      uses: envoyproxy/toolshed/gh-actions/bson@actions-v0.3.35
      with:
        catch-errors: true
        input: |
          OUTPUT=$(find ./artifacts -type f | xargs -I{} sh -c 'echo "$(stat -c %s "{}") {}"')
        filter: bash::output
        input-format: text
        options: -Rr
        result-filter-options: -sRc
        result-filter: |
          .
          | split("\n")
          | map(
              select(length > 0)
              | split(" ")
              | {key: (.[1] | split("/")[-1]), value: {path: .[1], size: .[0]}}
            )
          | from_entries

    - name: List downloaded artifacts
      id: artifact-sizes
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.3.35
      with:
        input: ${{ steps.artifacts.outputs.output }}
        filter: |
          map_values(.size)

    - name: Workflow Status Summary Header
      uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.3.35
      with:
        input: |
          sha: ${{ inputs.sha }}
          conclusion: ${{ inputs.conclusion }}
          continue: ${{ steps.afterall.outputs.continue }}
          repository: ${{ github.repository }}
          pr: ${{ steps.find-pr.outputs.output }}
          commit_info: ${{ steps.commit-info.outputs.output }}
        input-format: yaml
        options: -r
        output-path: GITHUB_STEP_SUMMARY
        filter: |
          .sha as $sha
          | .conclusion as $conclusion
          | .continue as $continue
          | .repository as $repo
          | .pr as $prInfo
          | .commit_info as $commitInfo
          | (if $prInfo != null and $prInfo != "{}" and $prInfo != "" then
               $prInfo | if type == "object" then . else fromjson end
             else {} end) as $pr
          | (if $commitInfo != null and $commitInfo != "{}" and $commitInfo != "" then
               $commitInfo | if type == "object" then . else fromjson end
             else {} end) as $commit
          | (if $pr.number then
               $pr.title // "PR #\($pr.number)"
             elif $commit.message then
               $commit.message | split("\n")[0]
             else
               $sha[0:7]
             end) as $title
          | (if $pr.number then
               " ([PR #\($pr.number)](https://github.com/\($repo)/pull/\($pr.number)))"
             else ""
             end) as $prLink
          | "## Publish Workflow Triggered\n\n"
            + "**\($title)**\n\n"
            + "**Commit:** [\($sha[0:7])](https://github.com/\($repo)/commit/\($sha))\($prLink)  \n"
            + "**Conclusion:** \($conclusion)  \n"
            + "**Continue:** \($continue)\n\n"

    - name: Generate workflow artifacts table
      uses: envoyproxy/toolshed/gh-actions/json/table@actions-v0.3.35
      with:
        title: Artifacts to publish
        append: true
        output-path: GITHUB_STEP_SUMMARY
        headers: |
          Name
          Size
        json: ${{ steps.artifact-sizes.outputs.value }}

    - name: Generate workflow status table
      uses: envoyproxy/toolshed/gh-actions/json/table@actions-v0.3.35
      with:
        title: Required Workflows Status
        append: true
        output-path: GITHUB_STEP_SUMMARY
        columns: 4
        headers: |
          Workflow
          Status
          Conclusion
          Run
        json: |
          ${{ steps.afterall.outputs.status }}
        filter: |
          . as $data
          | (.status | fromjson) as $status
          | ($data["run-ids"] | fromjson) as $runIds
          | "${{ inputs.workflows }}" | split("\n") | map(select(length > 0)) as $workflows
          | ${{ toJSON(github.repository) }} as $repo
          | $workflows
          | map(
              . as $wf
              | if $status[$wf] then
                  $status[$wf] as $st
                  | {key: "[#\($wf)](https://github.com/\($repo)/actions/runs/\($st.id))", value: "\($st.status)/\($st.conclusion)"}
                else
                  {key: $wf, value: "-"}
                end
            )
          | from_entries
