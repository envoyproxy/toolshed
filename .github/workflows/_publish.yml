name: _publish

permissions:
  actions: read

on:
  workflow_call:
    inputs:
      conclusion:
        default: ${{ github.event.workflow_run.conclusion }}
        type: string
      sha:
        default: ${{ github.event.workflow_run.head_sha }}
        type: string
      workflows:
        type: string
        required: true


jobs:
  check-and-publish:
    permissions:
      actions: read
    if: ${{ inputs.conclusion == 'success' }}
    runs-on: ubuntu-24.04
    steps:
    - name: Check all workflows ran
      id: afterall
      uses: envoyproxy/toolshed/gh-actions/github/afterall@bf09e91fd215754df30e54a293983484845465ca
      with:
        sha: ${{ inputs.sha }}
        workflows: ${{ inputs.workflows }}
    - name: Workflow trigger summary
      run: |
        echo "## Publish Workflow Triggered" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit SHA:** \`${{ inputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by workflow conclusion:** \`${{ inputs.conclusion }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Required workflows:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "${{ inputs.workflows }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**All workflows passed:** \`${{ steps.afterall.outputs.continue }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Workflow Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        STATUS_JSON='${{ steps.afterall.outputs.status }}'
        echo "$STATUS_JSON" | jq -r 'to_entries | .[] | "- **\(.key)**: ID \(.value.id) - Status: `\(.value.status)` - Conclusion: `\(.value.conclusion)`"' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ steps.afterall.outputs.continue }}" == "true" ]]; then
          echo "### ✅ Proceeding with artifact download and publish" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run IDs:**" >> $GITHUB_STEP_SUMMARY
          RUN_IDS='${{ steps.afterall.outputs.run-ids }}'
          echo "$RUN_IDS" | jq -r 'to_entries | .[] | "- **\(.key)**: [\(.value)](https://github.com/${{ github.repository }}/actions/runs/\(.value))"' >> $GITHUB_STEP_SUMMARY
        else
          echo "### ⚠️ Not all workflows passed - skipping publish" >> $GITHUB_STEP_SUMMARY
        fi
    - name: Download Artifacts (Bazel CI)
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      uses: actions/download-artifact@v4
      with:
        run-id: ${{ fromJSON(steps.afterall.outputs.run-ids)['Bazel CI'] }}
        path: ./artifacts/bazel
    - name: Download Artifacts (Rust CI)
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      uses: actions/download-artifact@v4
      with:
        run-id: ${{ fromJSON(steps.afterall.outputs.run-ids)['Rust CI'] }}
        path: ./artifacts/rust

    - name: Publish / Release
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      run: |
        echo "Deploying artifacts..."
        mkdir -p artifacts
        ls -R ./artifacts
