name: _publish

permissions:
  actions: read

on:
  workflow_call:
    inputs:
      conclusion:
        default: ${{ github.event.workflow_run.conclusion }}
        type: string
      sha:
        default: ${{ github.event.workflow_run.head_sha }}
        type: string
      workflows:
        type: string
        required: true


jobs:
  check-and-publish:
    permissions:
      actions: read
    if: ${{ inputs.conclusion == 'success' }}
    runs-on: ubuntu-24.04
    steps:
    - name: Check all workflows ran
      id: afterall
      uses: envoyproxy/toolshed/gh-actions/github/afterall@bf09e91fd215754df30e54a293983484845465ca
      with:
        sha: ${{ inputs.sha }}
        workflows: ${{ inputs.workflows }}
    - name: Workflow Status Summary
      run: |
        echo "## Publish Workflow Triggered" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit SHA:** \`${{ inputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Conclusion:** ${{ inputs.conclusion }}" >> $GITHUB_STEP_SUMMARY
        echo "**Continue:** ${{ steps.afterall.outputs.continue }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Required Workflows Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Parse and display the status of each workflow
        if echo '${{ steps.afterall.outputs.status }}' | jq -r '
          to_entries | .[] |
          "- **\(.key):** Status: `\(.value.status)`, Conclusion: `\(.value.conclusion)`, Run ID: `\(.value.id)`"
        ' >> $GITHUB_STEP_SUMMARY 2>/dev/null; then
          echo "" >> $GITHUB_STEP_SUMMARY
        else
          echo "_Status information unavailable_" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        echo "### Workflow Run IDs" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Display the run IDs being used for artifact downloads
        if echo '${{ steps.afterall.outputs.run-ids }}' | jq -r '
          to_entries | .[] |
          "- **\(.key):** [\(.value)](https://github.com/${{ github.repository }}/actions/runs/\(.value))"
        ' >> $GITHUB_STEP_SUMMARY 2>/dev/null; then
          :
        else
          echo "_Run ID information unavailable_" >> $GITHUB_STEP_SUMMARY
        fi
    - name: Download Artifacts (Bazel CI)
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      uses: actions/download-artifact@v4
      with:
        run-id: ${{ fromJSON(steps.afterall.outputs.run-ids)['Bazel CI'] }}
        path: ./artifacts/bazel
    - name: Download Artifacts (Rust CI)
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      uses: actions/download-artifact@v4
      with:
        run-id: ${{ fromJSON(steps.afterall.outputs.run-ids)['Rust CI'] }}
        path: ./artifacts/rust

    - name: Publish / Release
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      run: |
        echo "Deploying artifacts..."
        mkdir -p artifacts
        ls -R ./artifacts
