name: _publish

permissions:
  actions: read

on:
  workflow_call:
    inputs:
      conclusion:
        default: ${{ github.event.workflow_run.conclusion }}
        type: string
      sha:
        default: ${{ github.event.workflow_run.head_sha }}
        type: string
      workflows:
        type: string
        required: true


jobs:
  check-and-publish:
    permissions:
      actions: read
    if: ${{ inputs.conclusion == 'success' }}
    runs-on: ubuntu-24.04
    steps:
    - name: Check all workflows ran
      id: afterall
      uses: envoyproxy/toolshed/gh-actions/github/afterall@bf09e91fd215754df30e54a293983484845465ca
      with:
        sha: ${{ inputs.sha }}
        workflows: ${{ inputs.workflows }}
    - name: Find associated PR
      id: find-pr
      uses: envoyproxy/toolshed/gh-actions/bson@actions-v0.3.35
      env:
        GH_TOKEN: ${{ github.token }}
      with:
        catch-errors: true
        input: |
          repo: ${{ github.repository }}
          sha: ${{ inputs.sha }}
        input-format: yaml
        filter: |
          .repo as $repo
          | .sha as $sha
          | ("gh api --jq '[.[] | {number, created_at, title}] | sort_by(.created_at) | last' "
             + "\"/repos/\($repo)/commits/\($sha)/pulls\"") as $cmd
          | "OUTPUT=$(\($cmd))"
          | bash::output
        result-filter: |
          if . != "" and . != "null" then . else "{}" end
    - name: Get commit info
      id: commit-info
      uses: envoyproxy/toolshed/gh-actions/bson@actions-v0.3.35
      env:
        GH_TOKEN: ${{ github.token }}
      with:
        catch-errors: true
        input: |
          repo: ${{ github.repository }}
          sha: ${{ inputs.sha }}
        input-format: yaml
        filter: |
          .repo as $repo
          | .sha as $sha
          | "OUTPUT=$(gh api --jq '{message: .commit.message}' \"/repos/\($repo)/commits/\($sha)\")"
          | bash::output
        result-filter: |
          if . != "" and . != "null" then . else "{}" end
    - name: Download Artifacts (Bazel CI)
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      uses: actions/download-artifact@v4
      with:
        run-id: ${{ fromJSON(steps.afterall.outputs.run-ids)['Bazel CI'] }}
        github-token: ${{ github.token }}
        path: ./artifacts/bazel
    - name: Download Artifacts (Rust CI)
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      uses: actions/download-artifact@v4
      with:
        run-id: ${{ fromJSON(steps.afterall.outputs.run-ids)['Rust CI'] }}
        github-token: ${{ github.token }}
        path: ./artifacts/rust
    - name: List downloaded files
      id: list-files
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      run: |
        {
          echo 'files<<EOF'
          find ./artifacts -type f | while read -r file; do
            source=$(echo "$file" | sed 's|./artifacts/||' | cut -d'/' -f1)
            filename=$(basename "$file")
            size=$(ls -lh "$file" | awk '{print $5}')
            echo "{\"source\":\"$source\",\"file\":\"$filename\",\"size\":\"$size\"}"
          done | jq -s '.'
          echo 'EOF'
        } >> $GITHUB_OUTPUT
    - name: Generate workflow status table
      id: status-table
      uses: envoyproxy/toolshed/gh-actions/json/table@actions-v0.3.35
      with:
        headers: |
          Workflow
          Status
          Conclusion
          Run
        json: |
          ${{ steps.afterall.outputs.status }}
        filter: |
          . as $data
          | ($data.status | fromjson) as $status
          | ($data["run-ids"] | fromjson) as $runIds
          | ${{ toJSON(inputs.workflows) }} | split("\n") | map(select(length > 0)) as $workflows
          | ${{ toJSON(github.repository) }} as $repo
          | $workflows | map(
              . as $wf
              | if $status[$wf] then
                  $status[$wf] as $st
                  | [$wf, $st.status, $st.conclusion, "[#\($st.id)](https://github.com/\($repo)/actions/runs/\($st.id))"]
                else
                  [$wf, "-", "-", "-"]
                end
            )
    - name: Generate files table
      id: files-table
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      uses: envoyproxy/toolshed/gh-actions/json/table@actions-v0.3.35
      with:
        headers: |
          Source
          File
          Size
        json: ${{ steps.list-files.outputs.files }}
        filter: |
          map([.source, .file, .size])
    - name: Workflow Status Summary Header
      uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.3.35
      with:
        input: |
          sha: ${{ inputs.sha }}
          conclusion: ${{ inputs.conclusion }}
          continue: ${{ steps.afterall.outputs.continue }}
          repository: ${{ github.repository }}
          pr: ${{ steps.find-pr.outputs.output }}
          commit_info: ${{ steps.commit-info.outputs.output }}
        input-format: yaml
        options: -r
        output-path: GITHUB_STEP_SUMMARY
        filter: |
          .sha as $sha
          | .conclusion as $conclusion
          | .continue as $continue
          | .repository as $repo
          | .pr as $prInfo
          | .commit_info as $commitInfo
          | (if $prInfo != "{}" and $prInfo != "" then
               $prInfo | if type == "object" then . else fromjson end
             else {} end) as $pr
          | (if $commitInfo != "{}" and $commitInfo != "" then
               $commitInfo | if type == "object" then . else fromjson end
             else {} end) as $commit
          | (if $pr.number then
               $pr.title // "PR #\($pr.number)"
             elif $commit.message then
               $commit.message | split("\n")[0]
             else
               $sha[0:7]
             end) as $title
          | (if $pr.number then
               " ([PR #\($pr.number)](https://github.com/\($repo)/pull/\($pr.number)))"
             else ""
             end) as $prLink
          | "## Publish Workflow Triggered\n\n"
            + "**\($title)**\n\n"
            + "**Commit:** [\($sha[0:7])](https://github.com/\($repo)/commit/\($sha))\($prLink)  \n"
            + "**Conclusion:** \($conclusion)  \n"
            + "**Continue:** \($continue)\n\n"
            + "### Required Workflows Status\n\n"
    - name: Append workflow status table
      run: |
        echo '${{ steps.status-table.outputs.table }}' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY
    - name: Append files table
      if: ${{ fromJSON(steps.afterall.outputs.continue) && steps.files-table.outputs.table != '' }}
      run: |
        echo '### Downloaded Files' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY
        echo '${{ steps.files-table.outputs.table }}' >> $GITHUB_STEP_SUMMARY

    - name: Publish / Release
      if: ${{ fromJSON(steps.afterall.outputs.continue) }}
      run: |
        echo "Deploying artifacts..."
        mkdir -p artifacts
        ls -R ./artifacts
