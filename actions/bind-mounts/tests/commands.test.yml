uses: ./actions/bind-mounts
with:
  mounts: |
    - src: /tmp/bind-commands-src
      target: /tmp/bind-commands-target
      command-pre: echo "PRE-MOUNT" >> /tmp/bind-commands-log.txt
      command-post: echo "POST-MOUNT" >> /tmp/bind-commands-log.txt

before:
- shell: bash
  run: |
    echo "START" > /tmp/bind-commands-log.txt
    sudo mkdir -p /tmp/bind-commands-src
    mkdir -p /tmp/bind-commands-target

after:
- shell: bash
  run: |
    if ! mountpoint -q /tmp/bind-commands-target; then
        echo "fail:/tmp/bind-commands-target is not a mount point" >> "$TEST_OUTPUT"
    else
        echo "success:/tmp/bind-commands-target is mounted" >> "$TEST_OUTPUT"
    fi

    if ! grep -q "PRE-MOUNT" /tmp/bind-commands-log.txt; then
        echo "fail:command-pre was not executed" >> "$TEST_OUTPUT"
        cat /tmp/bind-commands-log.txt
    else
        echo "success:command-pre was executed" >> "$TEST_OUTPUT"
    fi

    if ! grep -q "POST-MOUNT" /tmp/bind-commands-log.txt; then
        echo "fail:command-post was not executed" >> "$TEST_OUTPUT"
        cat /tmp/bind-commands-log.txt
    else
        echo "success:command-post was executed" >> "$TEST_OUTPUT"
    fi

    LOG_CONTENT=$(cat /tmp/bind-commands-log.txt)
    if ! echo "$LOG_CONTENT" | grep -q "START"; then
        echo "fail:START marker not found" >> "$TEST_OUTPUT"
    fi

    START_LINE=$(grep -n "START" /tmp/bind-commands-log.txt | cut -d: -f1)
    PRE_LINE=$(grep -n "PRE-MOUNT" /tmp/bind-commands-log.txt | cut -d: -f1)
    POST_LINE=$(grep -n "POST-MOUNT" /tmp/bind-commands-log.txt | cut -d: -f1)

    if [[ $PRE_LINE -le $START_LINE ]]; then
        echo "fail:PRE-MOUNT executed before START" >> "$TEST_OUTPUT"
        cat /tmp/bind-commands-log.txt
    else
        echo "success:PRE-MOUNT executed after START" >> "$TEST_OUTPUT"
    fi

    if [[ $POST_LINE -le $PRE_LINE ]]; then
        echo "fail:POST-MOUNT executed before PRE-MOUNT" >> "$TEST_OUTPUT"
        cat /tmp/bind-commands-log.txt
    else
        echo "success:POST-MOUNT executed after PRE-MOUNT" >> "$TEST_OUTPUT"
    fi

    sudo umount /tmp/bind-commands-target
    sudo rm -rf /tmp/bind-commands-src
    rm -rf /tmp/bind-commands-target /tmp/bind-commands-log.txt
