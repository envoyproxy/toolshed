uses: ./actions/bind-mounts
with:
  mounts: |
    - src: /tmp/bind-chown-src
      target: /tmp/bind-chown-target
      chown: runner:runner

before:
- shell: bash
  run: |
    sudo mkdir -p /tmp/bind-chown-src
    sudo chown root:root /tmp/bind-chown-src
    echo "test-content" | sudo tee /tmp/bind-chown-src/testfile.txt
    mkdir -p /tmp/bind-chown-target

after:
- shell: bash
  run: |
    if ! mountpoint -q /tmp/bind-chown-target; then
        echo "fail:/tmp/bind-chown-target is not a mount point" >> "$TEST_OUTPUT"
    else
        echo "success:/tmp/bind-chown-target is mounted" >> "$TEST_OUTPUT"
    fi

    SRC_OWNER=$(stat -c '%U' /tmp/bind-chown-src)
    SRC_GROUP=$(stat -c '%G' /tmp/bind-chown-src)

    if [[ "$SRC_OWNER" != "runner" ]]; then
        echo "fail:Source directory owner is $SRC_OWNER, expected runner" >> "$TEST_OUTPUT"
    else
        echo "success:Source directory owner is runner" >> "$TEST_OUTPUT"
    fi

    if [[ "$SRC_GROUP" != "runner" ]]; then
        echo "fail:Source directory group is $SRC_GROUP, expected runner" >> "$TEST_OUTPUT"
    else
        echo "success:Source directory group is runner" >> "$TEST_OUTPUT"
    fi

    echo "new-content" > /tmp/bind-chown-target/newfile.txt
    if [[ ! -f /tmp/bind-chown-target/newfile.txt ]]; then
        echo "fail:Could not write to mounted directory" >> "$TEST_OUTPUT"
    else
        echo "success:Successfully wrote to mounted directory as runner user" >> "$TEST_OUTPUT"
    fi

    sudo umount /tmp/bind-chown-target
    sudo rm -rf /tmp/bind-chown-src
    rm -rf /tmp/bind-chown-target
