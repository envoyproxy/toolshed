inputs:
  azp-org:
    type: string
    required: true
  azp-token:
    type: string
    required: true
  pool-id:
    type: string
    required: true

outputs:
  path:
    value: ${{ steps.fetch.outputs.path }}

runs:
  using: "composite"
  steps:
  - name: Checkout repository
    uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

  - id: fetch
    name: Fetch AZP agents list
    uses: envoyproxy/toolshed/actions/fetch@b947ebfe9eda97a0da3e1b3a6a3598fbb55de7b6
    with:
      url: https://dev.azure.com/${{ inputs.azp-org }}/_apis/distributedtask/pools/${{ inputs.pool-id }}/agents?api-version=7.1-preview.1
      args: -u ":${{ inputs.azp-token }}"

  - name: Get dead AZP agent ids
    uses: envoyproxy/toolshed/actions/jq@b947ebfe9eda97a0da3e1b3a6a3598fbb55de7b6
    with:
      input-format: json-path
      input: ${{ steps.fetch.outputs.path }}
      output-path: /tmp/agents
      print-result: true
      filter: |
        .value[]
        | select(.status="offline")
        | .id

  - run: |
      AZP_URL="https://dev.azure.com/${{ inputs.azp-org }}/_apis/distributedtask/pools/${{ inputs.pool-id }}"
      for agent in $(cat /tmp/agents); do
          echo "Deleting agent: ${agent}"
          curl -s -X DELETE -u ":${{ inputs.azp-token }}" \
            "${AZP_URL}/agents/$agent?api-version=7.1-preview.1"
      done
    shell: bash
