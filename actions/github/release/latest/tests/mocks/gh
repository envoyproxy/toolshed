#!/usr/bin/env bash

# Mock gh command for testing github/release/latest action
# Records all calls and responds with mock release data

set -e

MOCK_LOG="${MOCK_LOG:-/tmp/gh-mock.log}"

print_cmd() {
    local arg
    for arg in "$@"; do
        if [[ "$arg" =~ [[:space:]] ]]; then
            printf '"%s" ' "$arg"
        else
            printf '%s ' "$arg"
        fi
    done | sed 's/ $//'
    echo
}

print_cmd gh "$@" >> "$MOCK_LOG"

command="$1"
subcommand="${2:-}"

case "$command" in
    release)
        case "$subcommand" in
            list)
                # Parse arguments to determine what to return
                shift 2
                jq_filter=""

                while [[ $# -gt 0 ]]; do
                    case "$1" in
                        --jq)
                            jq_filter="$2"
                            shift 2
                            ;;
                        *)
                            shift
                            ;;
                    esac
                done

                # Return mock release list
                # Includes various release types to test pattern matching
                data='[
  {"tagName": "actions-v0.3.48"},
  {"tagName": "bins-v0.1.32"},
  {"tagName": "bazel-v0.3.14"},
  {"tagName": "bins-v0.1.31"},
  {"tagName": "actions-v0.3.47"},
  {"tagName": "python-v0.1.1"},
  {"tagName": "bins-v0.1.30"}
]'

                if [[ -n "$jq_filter" ]]; then
                    echo "$data" | jq -r "$jq_filter"
                else
                    echo "$data"
                fi
                exit 0
                ;;
        esac
        ;;
    *)
        echo "Unknown gh command: $command" >&2
        exit 1
        ;;
esac
