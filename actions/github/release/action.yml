inputs:
  artifact-workflows:
    type: string
    required: true
  artifacts:
    type: boolean
    default: true
  dry-run:
    type: boolean
    default: true
  event:
    type: string
    default:
  fail-if-exists:
    type: boolean
    default: true
  filter-artifacts:
    default: .
    type: string
  gpg-fingerprint:
    default:
    type: string
  gpg-passphrase:
    default:
    type: string
  name:
    type: string
    required: true
  prepare-dev:
    type: string
    required: false
  publish-directory:
    type: string
    default: artifacts/publish
  repository:
    type: string
    required: true
  sha:
    type: string
    required: true
  summary:
    type: boolean
    default: true
  template-artifacts:
    type: string
    default: |
      \($name)-{artifacts,source}*
  title:
    type: string
    default:
  token:
    type: string
    required: true
  version:
    type: string
    required: true
  version-file:
    type: string
    required: true
  workflows:
    type: string
    required: true

outputs:
  result:
    value: ${{ steps.release.outputs.output }}


runs:
  using: composite
  steps:
  - name: Check release status
    id: status
    uses: envoyproxy/toolshed/actions/github/release/status@e8ee8052b8ffcadf21b15635db4f162712799bdf
    with:
      name: ${{ inputs.name }}
      repository: ${{ inputs.repository }}
      sha: ${{ inputs.sha }}
      title: >-
        ${{ inputs.title }}
      version: ${{ inputs.version }}
      version-file: ${{ inputs.version-file }}
      workflows: ${{ inputs.workflows }}
  - id: artifacts
    if: >-
      fromJSON(steps.status.outputs.continue)
      && fromJSON(inputs.artifacts)
      && ! fromJSON(steps.status.outputs.version).is_dev
    name: Download artifacts from workflow runs
    uses: envoyproxy/toolshed/actions/github/release/artifacts@e8ee8052b8ffcadf21b15635db4f162712799bdf
    with:
      filter-artifacts: ${{ inputs.filter-artifacts }}
      gpg-fingerprint: ${{ inputs.gpg-fingerprint }}
      gpg-passphrase: ${{ inputs.gpg-passphrase }}
      run-ids: ${{ steps.status.outputs.run-ids }}
      publish-directory: ${{ inputs.publish-directory }}
      template-artifacts: ${{ inputs.template-artifacts }}
      workflows: ${{ inputs.artifact-workflows }}
  - name: Publish the release
    if: >-
      fromJSON(steps.status.outputs.continue)
      && ! fromJSON(steps.status.outputs.version).is_dev
    uses: envoyproxy/toolshed/actions/github/release/publish@e8ee8052b8ffcadf21b15635db4f162712799bdf
    with:
      assets: ${{ fromJSON(inputs.artifacts) && format('{0}/*', inputs.publish-directory) || '' }}
      dry-run: ${{ inputs.dry-run }}
      event: ${{ inputs.event }}
      fail-if-exists: ${{ inputs.fail-if-exists }}
      name: ${{ inputs.name }}
      prepare-dev: ${{ inputs.prepare-dev }}
      repository: ${{ inputs.repository }}
      sha: ${{ inputs.sha }}
      summary: ${{ inputs.summary }}
      token: ${{ inputs.token || github.token }}
      version: ${{ steps.status.outputs.version }}
      version-file: ${{ inputs.version-file }}
