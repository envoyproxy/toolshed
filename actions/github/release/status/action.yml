inputs:
  name:
    type: string
    required: true
  repository:
    type: string
    default: ${{ github.repository }}
  sha:
    type: string
    required: true
  title:
    type: string
    required: true
  template-status:
    type: string
    default: |
      ## Publish: \(.name) \($release_info)

      ### \(.title)

  version:
    type: string
    default:
  version-file:
    type: string
    required: true
  workflows:
    type: string
    required: true

outputs:
  continue:
    value: ${{ steps.afterall.outputs.continue }}
  run-ids:
    value: ${{ steps.afterall.outputs.run-ids }}
  version:
    value: ${{ steps.version.outputs.version }}


runs:
  using: composite
  steps:
  - name: Check all workflows ran
    id: afterall
    uses: envoyproxy/toolshed/actions/github/afterall@4dfe60c0747c93995a3d4a7d998bb231e4fadf64
    with:
      sha: ${{ inputs.sha }}
      workflows: ${{ inputs.workflows }}
      repo: ${{ inputs.repository }}
  - name: Version info
    id: version
    uses: envoyproxy/toolshed/actions/version@4dfe60c0747c93995a3d4a7d998bb231e4fadf64
    with:
      version: ${{ inputs.version }}
      version-file: ${{ inputs.version-file }}
  - name: Status summary title
    id: status-summary-title
    uses: envoyproxy/toolshed/actions/jq@4dfe60c0747c93995a3d4a7d998bb231e4fadf64
    with:
      input: |
        name: ${{ inputs.name }}
        title: >-
          ${{ inputs.title }}
        version: ${{ steps.version.outputs.version }}
      input-format: yaml
      options: -r
      output-path: GITHUB_STEP_SUMMARY
      filter: |
        .
        | (if .version.is_dev then ""
           else "(release: \(.name)-v\(.version.version))"
           end) as $release_info
        | "${{ inputs.template-status }}"
  - name: Versions info
    uses: envoyproxy/toolshed/actions/json/table@4dfe60c0747c93995a3d4a7d998bb231e4fadf64
    with:
      append: true
      output-path: GITHUB_STEP_SUMMARY
      collapse: false
      input: |
        continue: ${{ steps.afterall.outputs.continue }}
        name: ${{ inputs.name }}
        repository: ${{ inputs.repository }}
        sha: ${{ inputs.sha }}
        version: ${{ steps.version.outputs.version }}
      headers:
      input-format: yaml
      filter: |
        .
        | (if .version.is_dev then ""
           else " **(RELEASE)**"
           end) as $release
        | ("[\(.sha[0:7])](https://github.com/\(.repository)/commit/\(.sha))") as $commit
        | {
            "\(.name) version": "\(.version.version)\($release)",
            "commit": "\($commit)",
            "continue": .continue,
          }
  - name: Generate workflow status table
    uses: envoyproxy/toolshed/actions/json/table@4dfe60c0747c93995a3d4a7d998bb231e4fadf64
    with:
      title: Required Workflows Status
      append: true
      output-path: GITHUB_STEP_SUMMARY
      collapse-open: ${{ ! fromJSON(steps.afterall.outputs.continue) }}
      headers: |
        Workflow
        Status/conclusion
      input: |
        ${{ steps.afterall.outputs.status }}
      filter: |
        . as $data
        | (.status | fromjson) as $status
        | ($data["run-ids"] | fromjson) as $runIds
        | "${{ inputs.workflows }}" | split("\n") | map(select(length > 0)) as $workflows
        | ${{ toJSON(inputs.repository) }} as $repo
        | $workflows
        | map(
            . as $wf
            | if $status[$wf] then
                $status[$wf] as $st
                | ($st.conclusion // "pending") as $conclusion
                | {key: "[\($wf) (#\($st.id))](https://github.com/\($repo)/actions/runs/\($st.id))",
                   value: "`\($st.status)`/`\($conclusion)`"}
              else
                {key: $wf, value: "-"}
              end
          )
        | from_entries
