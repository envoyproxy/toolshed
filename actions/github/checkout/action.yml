inputs:
  ancestor-check:
    type: boolean
    default: true
  config:
    description: >-
      YAML configuration for actions/checkout. Supports all actions/checkout inputs.
      Special handling: 'ref' field triggers ancestor checking for non-PR workflows.
    type: string
    required: true
  branch:
    description: >-
      Target branch name. Defaults to the current github.ref.
      Used as the base branch for checkout and ancestor verification.
    type: string
    default: ${{ github.ref }}
  committer-name:
    description: >-
      Git committer name for subsequent git operations.
      If provided with committer-email, configures git user.name globally.
    type: string
    default:
  committer-email:
    description: >-
      Git committer email for subsequent git operations.
      If provided with committer-name, configures git user.email globally.
    type: string
    default:
  fetch-merge-commit:
    description: >-
      For PR workflows, whether to fetch and use the merge commit SHA instead of the HEAD commit.
      Enables testing the result of merging the PR into the target branch.
    type: boolean
    default: true
  pr:
    description: >-
      Pull request number for PR-specific checkout behavior.
      When provided, fetches the PR's merge commit (if fetch-merge-commit is true).
      When empty, enables ref ancestry checking for non-PR workflows.
    type: number
    default:
  token:
    description: >-
      GitHub token for authentication. Falls back to github.token if not provided.
      Used for API calls and git operations.
    type: string
    default:
  show-progress:
    description: >-
      Whether to show progress status during git operations.
      Passed through to actions/checkout.
    type: boolean
    default: false
  ssh-key:
    description: >-
      SSH private key for git authentication. When provided, uses SSH instead of token auth.
      Passed through to actions/checkout.
    type: string
  strip-prefix:
    description: >-
      Prefix to strip from the branch name in the output.
      Useful for removing common prefixes like organization names.
    type: string
    default:

outputs:
  branch-name:
    description: >-
      The sanitized branch name with refs/pull/ and refs/heads/ prefixes removed,
      and optional strip-prefix applied.
    value: ${{ steps.branch.outputs.value }}
  merge-commit:
    description: >-
      For PR workflows with fetch-merge-commit enabled, the SHA of the merge commit.
      Empty for non-PR workflows.
    value: ${{ steps.merge-commit.outputs.sha }}


runs:
  using: composite
  steps:
  - uses: envoyproxy/toolshed/actions/github/merge-commit@6a20085af231aba4c72d6866f94098343a8c5616
    id: merge-commit
    name: Fetch merge commit hash
    if: ${{ inputs.pr != '' && fromJSON(inputs.fetch-merge-commit) }}
    with:
      repository: ${{ github.repository }}
      pr: ${{ inputs.pr }}
      token: ${{ inputs.token || github.token }}
  # If its a not pr and the ref is set, fetch-depth is set to 0 (full history)
  # otherwise the config value is respected.
  - name: Parse YAML config
    id: parsed-config
    uses: envoyproxy/toolshed/actions/jq@6a20085af231aba4c72d6866f94098343a8c5616
    with:
      input: ${{ inputs.config || '{}' }}
      input-format: yaml
      print-result: true
      filter: |
        if "${{ steps.merge-commit.outputs.sha }}" != "" then
          .ref = "${{ steps.merge-commit.outputs.sha }}"
        elif (.ref | type == "null") then
          del(.ref)
        else . end
        | if (. | has("show-progress") | not) and "${{ inputs.show-progress }}" != "" then
            .["show-progress"] = ${{ inputs.show-progress }}
          else . end
        | if .["fetch-depth"] then
            .
          elif ${{ inputs.pr == '' }} and .ref then
            .["fetch-depth"] = 0
          else
            .["fetch-depth"] = 1
          end
        | if "${{ inputs.branch }}" != "" then
            .branch = "${{ inputs.branch }}"
          elif (.branch  != "") and (.branch | type != null) then
            .branch = .branch
          elif ("${{ inputs.branch }}" == "") then
            .branch = "${{ github.ref }}"
          else
            .branch = "main"
          end
        | if ${{ inputs.pr == '' }} then
            if .ref then
              .["requested-ref"] = .ref
            else . end
            | .ref = .branch
          else . end

  - name: Git config
    shell: bash
    run: |
      git config --global advice.detachedHead false
      git config --global init.defaultBranch main

  # Add ssh-key and token to config separately and last to minimize leak risk
  - name: Config
    id: config-token
    if: ${{ inputs.ssh-key == '' }}
    uses: envoyproxy/toolshed/actions/jq@6a20085af231aba4c72d6866f94098343a8c5616
    with:
      input: ${{ inputs.token || github.token }}
      options: -R
      input-format: secret
      filter: |
        . as $token
        | ${{ steps.parsed-config.outputs.value }} as $config
        | $config
        | .token = $token
        | del(.branch, .["requested-ref"])
  - name: Config
    id: config-ssh
    uses: envoyproxy/toolshed/actions/jq@6a20085af231aba4c72d6866f94098343a8c5616
    if: ${{ inputs.ssh-key != '' }}
    with:
      input: ${{ inputs.ssh-key }}
      options: -R
      input-format: secret
      filter: |
        . as $sshKey
        | ${{ steps.parsed-config.outputs.value }} as $config
        | $config
        | .["ssh-key"] = $sshKey
        | del(.branch, .["requested-ref"])
  - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
    name: Checkout repository
    with: ${{ fromJSON(steps.config-ssh.outputs.value || steps.config-token.outputs.value || '{}') }}
  - if: >-
      fromJSON(inputs.ancestor-check)
      && fromJSON(steps.parsed-config.outputs.value).requested-ref
      && inputs.pr == ''
    run: |
      if ! git merge-base --is-ancestor "${REF}" HEAD; then
          echo "Provided ref (${REF}) is not an ancestor of current branch" >&2
          exit 1
      fi
      git checkout "${REF}"
    name: Check provided ref
    shell: bash
    env:
      REF: ${{ fromJSON(steps.parsed-config.outputs.value).requested-ref }}
  - name: Configure committer
    if: ${{ inputs.committer-name && inputs.committer-email }}
    run: |
      git config --global user.name "$COMMITTER_NAME"
      git config --global user.email "$COMMITTER_EMAIL"
    env:
      COMMITTER_NAME: ${{ inputs.committer-name }}
      COMMITTER_EMAIL: ${{ inputs.committer-email }}
    shell: bash
  - id: branch
    uses: envoyproxy/toolshed/actions/jq@6a20085af231aba4c72d6866f94098343a8c5616
    with:
      input: ${{ fromJSON(steps.parsed-config.outputs.value).branch }}
      input-format: text
      options: -rR
      print-result: ${{ (fromJSON(env.CI_DEBUG || 'false') || fromJSON(env.RUNNER_DEBUG || 'false')) && true || false }}
      filter: |
        sub("^refs/pull/"; "")
        | sub("^refs/heads/"; "")
        | if "${{ inputs.strip-prefix }}" then
            sub("${{ inputs.strip-prefix }}"; "")
          else . end
