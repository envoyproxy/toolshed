inputs:
  to_remove:
    type: string
    default:
  background:
    type: boolean
    default: true
    description: "Run removal commands in background (true) or foreground (false). When true, returns immediately with PIDs as outputs."

outputs:
  pids:
    description: "Space-separated list of background process PIDs (only set when background: true)"
    value: ${{ steps.remove_cruft.outputs.pids }}

runs:
  using: composite
  steps:
  - id: remove_cruft
    name: Cruft removal
    run: |
      echo "Disk space before cruft removal"
      df -h
      if [[ -n "${{ inputs.to_remove }}" ]]; then
          TO_REMOVE=(${{ inputs.to_remove }})
      else
          TO_REMOVE=(${DEFAULT_DIRECTORIES})
      fi
      if [[ "${{ inputs.background }}" == "true" ]]; then
          # Run rm commands in background
          pids=()
          for removal in "${TO_REMOVE[@]}"; do
              echo "Removing: ${removal} (background) ..."
              sudo rm -rf "$removal" &
              pids+=($!)
          done
          echo "pids=${pids[*]}" >> $GITHUB_OUTPUT
          echo "Background removal started with PIDs: ${pids[*]}"
          exit 0
      fi
      # Run rm commands in foreground
      for removal in "${TO_REMOVE[@]}"; do
          echo "Removing: ${removal} ..."
          sudo rm -rf "$removal"
      done
      echo "Disk after cruft removal"
      df -h
    env:
      DEFAULT_DIRECTORIES: |
        /opt/hostedtoolcache
        /usr/local/lib/android
        /usr/local/.ghcup
    shell: bash
